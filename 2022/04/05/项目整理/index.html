<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"aeowind.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="如明日好景忽远忽近">
<meta property="og:type" content="article">
<meta property="og:title" content="项目细节理解">
<meta property="og:url" content="https://aeowind.github.io/2022/04/05/%E9%A1%B9%E7%9B%AE%E6%95%B4%E7%90%86/index.html">
<meta property="og:site_name" content="Aeo&#39;s Blog">
<meta property="og:description" content="如明日好景忽远忽近">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-05T13:11:49.834Z">
<meta property="article:modified_time" content="2022-04-20T09:49:56.240Z">
<meta property="article:author" content="aeowind">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://aeowind.github.io/2022/04/05/%E9%A1%B9%E7%9B%AE%E6%95%B4%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>项目细节理解 | Aeo's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Aeo's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">你要静候 再静候</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://aeowind.github.io/2022/04/05/%E9%A1%B9%E7%9B%AE%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="aeowind">
      <meta itemprop="description" content="爱上一场认真的消遣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aeo's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          项目细节理解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-05 21:11:49" itemprop="dateCreated datePublished" datetime="2022-04-05T21:11:49+08:00">2022-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-20 17:49:56" itemprop="dateModified" datetime="2022-04-20T17:49:56+08:00">2022-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/Java/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description"><blockquote class="blockquote-center">如明日好景忽远忽近</blockquote></div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="项目介绍">项目介绍</h1>
<h2 id="医院项目">医院项目</h2>
<p>面试官您好，我叫徐小凤，是北京邮电大学控制科学与工程研二的学生，今天应聘的是Java后端开发实习生的岗位。我在过去的学习和完成实验室项目的过程中，积累了一定的实践经验，包括完成了xx项目和xx项目，在技术上有良好的代码风格，遵循标准的开发规范，另外就是感觉自己对后端开发这方面相对更感兴趣，也能在一定程度上发挥自己的个人能力，因此希望获得一份后端开发实习的工作。</p>
<p><strong>医院预约挂号微服务系统 2021.10~2022.01</strong></p>
<p>n <strong>项目描述</strong>：基于SpringBoot+MySQL+SpringCloud
+MybatisPlus+Maven+Redis+Vue构建的医院预约挂号微服务系统，后台包括医院设置管理、数据管理、用户管理、订单管理和统计管理等功能，前台实现了用户登录、就诊人管理、实名认证和预约挂号等功能。</p>
<p>n
<strong>责任描述</strong>：完成了后台代码的编写，实现了医院相关数据管理；</p>
<p>通过Redis配置类实现了数据字典中数据的缓存，提高查询效率；</p>
<p>基于RabbitMQ实现了更新预约数和短信预约成功提醒的功能，提高下单的并发性；</p>
<p>基于SpringCloud实现远程调用，gateway配置网关，从中学习了常用微服务组件、消息队列等中间件的应用，对分布式系统和微服务有了更深的了解。</p>
<h2 id="快速路项目">快速路项目</h2>
<p><strong>城市快速路复杂环境多维安全监测系统
2021.06~2021.08</strong></p>
<p>n
<strong>项目描述</strong>：基于SpringMVC+MySQL+Maven+Mybatis+bootstrap构建的快速路复杂环境安全监测系统，后台包括用户管理、道路异常视频监测、光纤数据异常监测、事故统计等功能，前台实现了用户登录、数据管理、道路异常分析等功能。</p>
<p>n
<strong>责任描述</strong>：参与项目功能讨论，完成了系统的前端及后台开发工作；</p>
<p>后台基于mybatis实现数据的增删改查，通过远程访问整合实现了道路视频流的调用，光纤信号采集画面调用；</p>
<p>前端实现了视频播放显示，光纤采集画面显示，数据融合列表展示、详情查看，事故地图定位显示功能的编码。</p>
<h1 id="项目模块构建">项目模块构建</h1>
<ul>
<li><p>hospital-manage：医院接口模拟端（已开发，直接使用）</p></li>
<li><p>yygh-parent：根目录，管理子模块：</p>
<ul>
<li><p>common：公共模块父节点</p>
<ul>
<li><p>common-util：工具类模块，所有模块都可以依赖于它</p></li>
<li><p>rabbit-util：rabbitmq业务封装</p></li>
<li><p>service-util：service服务的工具包，包含service服务的公共配置类，所有service模块依赖于它</p></li>
</ul></li>
<li><p>server-gateway：服务网关</p></li>
<li><p>model：实体类模块</p></li>
<li><p>service：api接口服务父节点</p>
<ul>
<li><p>service-hosp：医院api接口服务</p></li>
<li><p>service-cmn：公共api接口服务</p></li>
<li><p>service-user：用户api接口服务</p></li>
<li><p>service-order：订单api接口服务</p></li>
<li><p>service-oss：文件api接口服务</p></li>
<li><p>service-sms：短信 api接口服务</p></li>
<li><p>service-task：定时任务服务</p></li>
<li><p>service-statistics：统计api接口服务</p></li>
</ul></li>
<li><p>service-client：feign服务调用父节点</p>
<ul>
<li><p>service-cmn-client：公共api接口</p></li>
<li><p>service-hosp-client：医院api接口</p></li>
<li><p>service-order-client：订单api接口</p></li>
</ul></li>
</ul></li>
<li><p>service-user：用户api接口</p></li>
</ul>
<h1 id="表结构">表结构</h1>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"># Host: localhost  (Version <span class="number">5.7</span><span class="number">.19</span><span class="operator">-</span>log)</span><br><span class="line"># <span class="type">Date</span>: <span class="number">2020</span><span class="number">-07</span><span class="number">-31</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">29</span></span><br><span class="line"># Generator: MySQL<span class="operator">-</span>Front <span class="number">6.1</span>  (Build <span class="number">1.26</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Database &quot;yygh_cmn&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `yygh_cmn` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line">USE `yygh_cmn`;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;dict&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dict` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `parent_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;上级id&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;名称&#x27;</span>,</span><br><span class="line">  `<span class="keyword">value</span>` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;值&#x27;</span>,</span><br><span class="line">  `dict_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;编码&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;删除标记（0:不可用 1:可用）&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_dict_code` (`dict_code`),</span><br><span class="line">  KEY `idx_parent_id` (`parent_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;组织架构表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Database &quot;yygh_hosp&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `yygh_hosp` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4;</span><br><span class="line">USE `yygh_hosp`;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;hospital_set&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `hospital_set` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `hosname` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医院名称&#x27;</span>,</span><br><span class="line">  `hoscode` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医院编号&#x27;</span>,</span><br><span class="line">  `api_url` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;api基础路径&#x27;</span>,</span><br><span class="line">  `sign_key` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;签名秘钥&#x27;</span>,</span><br><span class="line">  `contacts_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人&#x27;</span>,</span><br><span class="line">  `contacts_phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人手机&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_hoscode` (`hoscode`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;医院设置表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Database &quot;yygh_order&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `yygh_order` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line">USE `yygh_order`;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;order_info&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `order_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `out_trade_no` <span class="type">varchar</span>(<span class="number">300</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单交易号&#x27;</span>,</span><br><span class="line">  `hoscode` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医院编号&#x27;</span>,</span><br><span class="line">  `hosname` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医院名称&#x27;</span>,</span><br><span class="line">  `depcode` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;科室编号&#x27;</span>,</span><br><span class="line">  `depname` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;科室名称&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医生职称&#x27;</span>,</span><br><span class="line">  `hos_schedule_id` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;排班编号（医院自己的排班主键）&#x27;</span>,</span><br><span class="line">  `reserve_date` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;安排日期&#x27;</span>,</span><br><span class="line">  `reserve_time` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;安排时间（0：上午 1：下午）&#x27;</span>,</span><br><span class="line">  `patient_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;就诊人id&#x27;</span>,</span><br><span class="line">  `patient_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;就诊人名称&#x27;</span>,</span><br><span class="line">  `patient_phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;就诊人手机&#x27;</span>,</span><br><span class="line">  `hos_record_id` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;预约记录唯一标识（医院预约记录主键）&#x27;</span>,</span><br><span class="line">  `number` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;预约号序&#x27;</span>,</span><br><span class="line">  `fetch_time` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;建议取号时间&#x27;</span>,</span><br><span class="line">  `fetch_address` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;取号地点&#x27;</span>,</span><br><span class="line">  `amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医事服务费&#x27;</span>,</span><br><span class="line">  `quit_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;退号时间&#x27;</span>,</span><br><span class="line">  `order_status` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单状态&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_out_trade_no` (`out_trade_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_hoscode` (`hoscode`),</span><br><span class="line">  KEY `idx_hos_schedule_id` (`hos_schedule_id`),</span><br><span class="line">  KEY `idx_hos_record_id` (`hos_record_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">12</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;订单表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;payment_info&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `payment_info` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `out_trade_no` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;对外业务编号&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `payment_type` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付类型（微信 支付宝）&#x27;</span>,</span><br><span class="line">  `trade_no` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易编号&#x27;</span>,</span><br><span class="line">  `total_amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付金额&#x27;</span>,</span><br><span class="line">  `subject` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易内容&#x27;</span>,</span><br><span class="line">  `payment_status` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付状态&#x27;</span>,</span><br><span class="line">  `callback_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调时间&#x27;</span>,</span><br><span class="line">  `callback_content` <span class="type">varchar</span>(<span class="number">1000</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调信息&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_out_trade_no` (`out_trade_no`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;支付信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;refund_info&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `refund_info` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `out_trade_no` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;对外业务编号&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单编号&#x27;</span>,</span><br><span class="line">  `payment_type` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付类型（微信 支付宝）&#x27;</span>,</span><br><span class="line">  `trade_no` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易编号&#x27;</span>,</span><br><span class="line">  `total_amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;退款金额&#x27;</span>,</span><br><span class="line">  `subject` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易内容&#x27;</span>,</span><br><span class="line">  `refund_status` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;退款状态&#x27;</span>,</span><br><span class="line">  `callback_content` <span class="type">varchar</span>(<span class="number">1000</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调信息&#x27;</span>,</span><br><span class="line">  `callback_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_out_trade_no` (`out_trade_no`),</span><br><span class="line">  KEY `idx_order_id` (`order_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;退款信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Database &quot;yygh_user&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `yygh_user` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line">USE `yygh_user`;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;patient&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `patient` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `certificates_type` <span class="type">varchar</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;证件类型&#x27;</span>,</span><br><span class="line">  `certificates_no` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;证件编号&#x27;</span>,</span><br><span class="line">  `sex` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `birthdate` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;出生年月&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机&#x27;</span>,</span><br><span class="line">  `is_marry` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否结婚&#x27;</span>,</span><br><span class="line">  `province_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省code&#x27;</span>,</span><br><span class="line">  `city_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市code&#x27;</span>,</span><br><span class="line">  `district_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;区code&#x27;</span>,</span><br><span class="line">  `address` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;详情地址&#x27;</span>,</span><br><span class="line">  `contacts_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人姓名&#x27;</span>,</span><br><span class="line">  `contacts_certificates_type` <span class="type">varchar</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人证件类型&#x27;</span>,</span><br><span class="line">  `contacts_certificates_no` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人证件号&#x27;</span>,</span><br><span class="line">  `contacts_phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人手机&#x27;</span>,</span><br><span class="line">  `card_no` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;就诊卡号&#x27;</span>,</span><br><span class="line">  `is_insure` tinyint(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否有医保&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态（0：默认 1：已认证）&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">8</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;就诊人表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;user_info&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `openid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;微信openid&#x27;</span>,</span><br><span class="line">  `nick_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户姓名&#x27;</span>,</span><br><span class="line">  `certificates_type` <span class="type">varchar</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;证件类型&#x27;</span>,</span><br><span class="line">  `certificates_no` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;证件编号&#x27;</span>,</span><br><span class="line">  `certificates_url` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;证件路径&#x27;</span>,</span><br><span class="line">  `auth_status` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;认证状态（0：未认证 1：认证中 2：认证成功 -1：认证失败）&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;状态（0：锁定 1：正常）&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `uk_mobile` (`phone`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">8</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure <span class="keyword">for</span> <span class="keyword">table</span> &quot;user_login_record&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_login_record` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `ip` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ip&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除(1:已删除，0:未删除)&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">40</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户登录记录表&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="医院设置表结构">医院设置表结构</h2>
<p>医院设置主要是用来保存开通医院的一些基本信息，每个医院一条信息，保存了医院编号（平台分配，全局唯一）和接口调用相关的签名key等信息，是整个流程的第一步，只有开通了医院设置信息，才可以上传医院相关信息。</p>
<p>我们所开发的功能就是基于单表的一个CRUD、锁定/解锁和发送签名信息这些基本功能。</p>
<p>主索引：id</p>
<p>hosname：医院名称</p>
<p>hoscode：医院编号（平台分配，全局唯一，api接口必填信息）</p>
<p>api_url：医院回调的基础url（如：预约下单，我们要调用该地址去医院下单）</p>
<p>sign_key：双方api接口调用的签名key，有平台生成</p>
<p>contacts_name：医院联系人姓名</p>
<p>contacts_phone：医院联系人手机</p>
<p>status：状态（锁定/解锁）</p>
<h2 id="数据字典表结构">数据字典表结构</h2>
<p>数据字典就是管理系统常用的分类数据或者一些固定数据，例如：省市区三级联动数据、民族数据、行业数据、学历数据等，由于该系统大量使用这种数据，所以我们要做一个数据管理方便管理系统数据，一般系统基本都会做数据管理。</p>
<p>parent_id：</p>
<p>上级id，通过id与parent_id构建上下级关系，例如：我们要获取所有行业数据，那么只需要查询parent_id=20000的数据</p>
<p>name：名称，例如：填写用户信息，我们要select标签选择民族，“汉族”就是数据字典的名称</p>
<p>value：值，例如：填写用户信息，我们要select标签选择民族，“1”（汉族的标识）就是数据字典的值</p>
<p>dict_code：编码，编码是我们自定义的，全局唯一，例如：我们要获取行业数据，我们可以通过parent_id获取，但是parent_id是不确定的，所以我们可以根据编码来获取行业数据</p>
<p>系统中会使用省市区三级联动数据，该数据我们来自“国家统计局”官方数据</p>
<p>由于我们的医院等级、省市区地址都是取的数据字典value值，因此我们在列表显示医院等级与医院地址时要根据数据字典value值获取数据字典名称</p>
<p>通过学习数据字典我们知道，根据上级编码与value值可以获取对应的数据字典名称，如果value值能够保持唯一（不一定唯一），我们也可以直接通过value值获取数据字典名称，目前省市区三级数据我们使用的是国家统计局的数据，数据编码我们就是数据字典的id与value，所以value能够唯一确定一条数据字典，如图：</p>
<h2 id="医院全局唯一编号">医院全局唯一编号</h2>
<p>使用MD5算法。</p>
<p><strong>什么是MD5算法</strong></p>
<p><a
target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=MD5&amp;spm=1001.2101.3001.7020">MD5</a>讯息摘要演算法（英语：MD5
Message-Digest
Algorithm），一种被广泛使用的密码杂凑函数，可以产生出一个128位元（16位元组）的散列值（hash
value），用于确保信息传输完整一致。</p>
<p><strong>MD5功能</strong></p>
<p>输入任意长度的信息，经过处理，输出为128位的信息（数字指纹）；
不同的输入得到的不同的结果（唯一性）；</p>
<p><strong>MD5属不属于加密算法</strong></p>
<p>认为不属于的人是因为他们觉得不能从密文（<a
target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=散列&amp;spm=1001.2101.3001.7020">散列</a>值）反过来得到原文，即没有解密算法，所以这部分人认为MD5只能属于算法，不能称为加密算法；
认为属于的人是因为他们觉得经过MD5处理后看不到原文，即已经将原文加密，所以认为MD5属于加密算法；我个人支持前者，正如认为BASE64算法只能算编码一样。</p>
<p><strong>MD5算法是否可逆？</strong></p>
<p>MD5不可逆的原因是其是一种散列函数，使用的是<a
target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=hash&amp;spm=1001.2101.3001.7020">hash</a>算法，在计算过程中原文的部分信息是丢失了的。</p>
<p><strong>MD5用途</strong></p>
<p>1.防止被篡改：
1）比如发送一个电子文档，发送前，我先得到MD5的输出结果a。然后在对方收到电子文档后，对方也得到一个MD5的输出结果b。如果a与b一样就代表中途未被篡改。
2）比如我提供文件下载，为了防止不法分子在安装程序中添加木马，我可以在网站上公布由安装文件得到的MD5输出结果。
3）SVN在检测文件是否在CheckOut后被修改过，也是用到了MD5.</p>
<p>2.防止直接看到明文：
现在很多网站在数据库存储用户的密码的时候都是存储用户密码的MD5值。这样就算不法分子得到数据库的用户密码的MD5值，也无法知道用户的密码。（比如在UNIX系统中用户的密码就是以MD5（或其它类似的算法）经加密后存储在文件系统中。当用户登录的时候，系统把用户输入的密码计算成MD5值，然后再去和保存在文件系统中的MD5值进行比较，进而确定输入的密码是否正确。通过这样的步骤，系统在并不知道用户密码的明码的情况下就可以确定用户登录系统的合法性。这不但可以避免用户的密码被具有系统管理员权限的用户知道，而且还在一定程度上增加了密码被破解的难度。）</p>
<p>3.防止抵赖（数字签名）：
这需要一个第三方认证机构。例如A写了一个文件，认证机构对此文件用MD5算法产生摘要信息并做好记录。若以后A说这文件不是他写的，权威机构只需对此文件重新产生摘要信息，然后跟记录在册的摘要信息进行比对，相同的话，就证明是A写的了。这就是所谓的“数字签名”。</p>
<p><strong>MD5安全性</strong></p>
<p>普遍认为MD5是很安全，因为暴力破解的时间是一般人无法接受的。实际上如果把用户的密码MD5处理后再存储到数据库，其实是很不安全的。因为用户的密码是比较短的，而且很多用户的密码都使用生日，手机号码，身份证号码，电话号码等等。或者使用常用的一些吉利的数字，或者某个英文单词。如果我把常用的密码先MD5处理，把数据存储起来，然后再跟你的MD5结果匹配，这时我就有可能得到明文。比如某个MD5破解网站http://www.cmd5.com/default.aspx，所以现在大多数网站密码的策略是强制要求用户使用数字大小写字母的组合的方式提高用户密码的安全度。</p>
<h2 id="图片base64编码">图片base64编码</h2>
<p>图片的base64编码就是可以将一张图片数据编码成一串字符串，使用该字符串代替图像地址url</p>
<ol type="1">
<li>优点</li>
</ol>
<p>（1）base64格式的图片是文本格式，占用内存小，转换后的大小比例大概为1/3，降低了资源服务器的消耗；</p>
<p>（2）网页中使用base64格式的图片时，不用再请求服务器调用图片资源，减少了服务器访问次数。</p>
<ol start="2" type="1">
<li>缺点</li>
</ol>
<p>（1）base64格式的文本内容较多，存储在数据库中增大了数据库服务器的压力；</p>
<p>（2）网页加载图片虽然不用访问服务器了，但因为base64格式的内容太多，所以加载网页的速度会降低，可能会影响用户的体验。</p>
<h1 id="数据字典导入导出">数据字典导入导出</h1>
<p>整合<code>easyExcel</code>实现数据字典中数据的导入导出，<code>easyExcel</code>是一个基于Java的简单、省内存的读写Excel的开源项目，在尽可能节省内存的情况下支持读写百M的Excel。</p>
<p>在实现导入方法时，需要创建一个回调监听器。</p>
<p>一行一行读取Excel的。</p>
<h2 id="easyexcel工作原理">easyexcel工作原理</h2>
<ol type="1">
<li>文件解压文件读取通过文件形式</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/qXkWy6"><img
src="https://s1.ax1x.com/2022/04/05/qXkWy6.md.png"
alt="qXkWy6.md.png" /></a></p>
<ol start="2" type="1">
<li><p>避免将全部全部数据一次加载到内存</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/qXkTFH"><img
src="https://s1.ax1x.com/2022/04/05/qXkTFH.md.png"
alt="qXkTFH.md.png" /></a></p>
<ol start="3" type="1">
<li><p>抛弃不重要的数据</p>
<p>Excel解析时候会包含样式，字体，宽度等数据，但这些数据是我们不关心的，如果将这部分数据抛弃可以大大降低内存使用。Excel中数据如下Style占了相当大的空间。</p></li>
</ol></li>
</ol>
<h2 id="listener">Listener</h2>
<h3 id="正确使用-listener">正确使用 Listener</h3>
<ul>
<li><code>invoke</code> 数据校验、数据转换等工作</li>
<li><code>doAfterAllAnalysed</code> 整个excel解析结束时执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析监听器，</span></span><br><span class="line"><span class="comment"> * 每解析一行会回调invoke()方法。</span></span><br><span class="line"><span class="comment"> * 整个excel解析结束会执行doAfterAllAnalysed()方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: tanpeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020-02-07 14:55</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: v1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConverterDataListener</span> <span class="keyword">extends</span> <span class="title class_">AnalysisEventListener</span>&lt;ConverterData&gt; &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(ConverterData data, AnalysisContext context)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 数据校验、数据转换等工作</span></span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (data.getString().contains(<span class="string">&quot;5&quot;</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 不处理本条数据</span></span><br><span class="line">                <span class="comment">// return;</span></span><br><span class="line">                <span class="comment">// 直接结束数据处理，不再处理后面的数据 throw new RuntimeException()</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;包含数字5&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 处理数据</span></span><br><span class="line">                System.out.println(data.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 处理完毕</span></span><br><span class="line">        System.out.println(<span class="string">&quot;done&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="错误使用-listener">错误使用 Listener</h3>
<p>新同学很容易，会像下面的代码一样使用<code>ObjectListener</code>，声明一个空的<code>list</code>容器用来保存<code>invoke</code>中返回的每条数据，这样其实又是将数据放在了内存中进行计算，当解析大文件时，同样会OOM</p>
<p>实际上<code>easyexcel</code>使用 SAX 模式解析，每次只返回一条数据。
返回的这一条数据就是<code>invoke</code>方法的第一个参数，<strong>在<code>invoke</code>方法中应该做<code>数据校验、数据转换</code>等工作，而不是将数据又逐条往内存里放，放到最后说不定又到了OOM的局面</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析监听器，</span></span><br><span class="line"><span class="comment"> * 每解析一行会回调invoke()方法。</span></span><br><span class="line"><span class="comment"> * 整个excel解析结束会执行doAfterAllAnalysed()方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: tanpeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020-02-07 13:00</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: v1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectListener</span> <span class="keyword">extends</span> <span class="title class_">AnalysisEventListener</span>&lt;Object&gt; &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span>: 默认范型为 LinkedHashMap&lt;Integer, String&gt; &#123;<span class="doctag">@link</span> MapCache&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span>: tanpeng</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> : 2020-02-07 14:33</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@version</span>: v1.0.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Object data, AnalysisContext context)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">            list.add(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="数据字典redis缓存">数据字典Redis缓存</h2>
<p><strong>Spring Cache + Redis</strong> 缓存数据</p>
<h3 id="缓存cacheable">缓存@Cacheable</h3>
<p>根据方法对其返回结果进行缓存，下次请求时，如果缓存存在，则直接读取缓存数据返回；如果缓存不存在，则执行方法，并把返回的结果存入缓存中。一般用在查询方法上。</p>
<h3 id="缓存cacheput">缓存@CachePut</h3>
<p>使用该注解标志的方法，每次都会执行，并将结果存入指定的缓存中。其他方法可以直接从响应的缓存中读取缓存数据，而不需要再去查询数据库。一般用在新增方法上。</p>
<h1 id="网关">网关</h1>
<p>API网关出现的原因是微服务架构的出现，不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题：</p>
<p>（1）客户端会多次请求不同的微服务，增加了客户端的复杂性。</p>
<p>（2）存在跨域请求，在一定场景下处理相对复杂。</p>
<p>（3）认证复杂，每个服务都需要独立认证。</p>
<p>（4）难以重构，随着项目的迭代，可能需要重新划分微服务。例如，可能将多个服务合并成一个或者将一个服务拆分成多个。如果客户端直接与微服务通信，那么重构将会很难实施。</p>
<p>（5）某些微服务可能使用了防火墙 /
浏览器不友好的协议，直接访问会有一定的困难。</p>
<p>以上这些问题可以借助 API 网关解决。API
网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过API
网关这一层。也就是说，API
的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由 API
网关来做，这样既提高业务灵活性又不缺安全性</p>
<h2 id="nginx">Nginx</h2>
<p>由于我们后端有很多服务模块，每个模块都有对应的访问路径与端口，为了提供统一的api接口，所以使用nginx作为反向代理服务器；</p>
<p>反向代理，其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器IP地址</p>
<h2 id="跨域问题">跨域问题</h2>
<table>
<thead>
<tr class="header">
<th>跨域原因说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>域名不同</td>
<td>www.jd.com 与 www.taobao.com</td>
</tr>
<tr class="even">
<td>域名相同，端口不同</td>
<td>www.jd.com:8080 与 www.jd.com:8081</td>
</tr>
<tr class="odd">
<td>二级域名不同</td>
<td>item.jd.com 与 miaosha.jd.com</td>
</tr>
</tbody>
</table>
<h3 id="为什么有跨域问题">为什么有跨域问题？</h3>
<p>跨域不一定都会有跨域问题。</p>
<p>因为跨域问题是浏览器对于ajax请求的一种安全限制：一个页面发起的ajax请求，只能是与当前页域名相同的路径，这能有效的阻止跨站攻击。</p>
<p>因此：跨域问题 是针对ajax的一种限制。</p>
<p>但是这却给我们的开发带来了不便，而且在实际生产环境中，肯定会有很多台服务器之间交互，地址和端口都可能不同，怎么办？</p>
<h1 id="nosql">NoSQL</h1>
<p>为什么使用NoSQL :</p>
<ol type="1">
<li><p>对数据库高并发读写。</p></li>
<li><p>对海量数据的高效率存储和访问。</p></li>
<li><p>对数据库的高可扩展性和高可用性。</p></li>
</ol>
<p>弱点：</p>
<ol type="1">
<li><p>数据库事务一致性需求</p></li>
<li><p>数据库的写实时性和读实时性需求</p></li>
<li><p>对复杂的SQL查询，特别是多表关联查询的需求</p></li>
</ol>
<h2 id="适用场景">适用场景</h2>
<p><strong>适用场景</strong></p>
<ol type="1">
<li><p>网站数据：Mongo非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。</p></li>
<li><p>缓存：由于性能很高，Mongo也适合作为信息基础设施的缓存层。在系统重启之后，由M
ongo搭建的持久化缓存层可以避免下层的数据源过载。</p></li>
<li><p>大尺寸，低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵，
在此之前，很多时候程序员往往会选择传统的文件进行存储。</p></li>
<li><p>高伸缩性的场景：Mongo非常适合由数十或数百台服务器组成的数据库。Mongo的路线图中已经包含对Map
Reduce弓摩的内置支持。</p></li>
<li><p>用于对象及
JSON数据的存储：Mongo的BSON数据格式非常适合文档化格式的存储
及查询。</p></li>
</ol>
<p><strong>不适用场合</strong></p>
<ol type="1">
<li><p>高度事务性的系统：例如银行或会计系统。传统的关系型数据库目前还是更适用于需要大量原子性复杂事务的应用程序。</p></li>
<li><p>传统的商业智能应用：针对特定问题的BI数据库会对产生高度优化的查询方式。对于此类应用，数据仓库可能是更合适的选择。</p></li>
</ol>
<h1 id="手机登录">手机登录</h1>
<blockquote>
<p><strong>UserInfoServiceImpl方法</strong></p>
</blockquote>
<ul>
<li>从loginVo获取输入的手机号和验证码，</li>
<li>判断手机号和验证码是否为空，</li>
<li>判断验证码是否一致，</li>
<li>判断是否为第一次登录，根据手机号查询数据库，如果不存在相同手机号就是第一次登录，第一次使用这个手机号登录，添加信息到数据库，</li>
<li>不是第一次，直接登录，校验用户是否被禁用，</li>
<li>登录后返回登录的一些信息，返回登录用户名，返回token信息。</li>
</ul>
<h2 id="token生成">token生成</h2>
<ul>
<li>完成登录</li>
<li>生成字符串，包含用户信息（比如用户名）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每个请求操作，判断登录。在请求头里面，查看是否包含token字符串，如果包含，对字符串做校验，验证是否是我们生成的token。</span><br></pre></td></tr></table></figure>
<p>采用<strong>JWT</strong>生成token。</p>
<p>JWT最重要的作用就是对 token信息的<strong>防伪</strong>作用。</p>
<blockquote>
<p>JWT的原理</p>
</blockquote>
<p>一个JWT由三个部分组成：公共部分、私有部分、签名部分。最后由这三者组合进行base64编码得到JWT。</p>
<h2 id="手机验证码的发送">手机验证码的发送</h2>
<p>使用阿里云短信服务，发送手机验证码。</p>
<ul>
<li><p>从Redis里获取手机验证码，如果获取到，返回ok。</p></li>
<li><p>如果从Redis里获取不到，生成验证码，通过整合短信服务进行发送。</p></li>
<li><p>生成验证码放到Redis里，设置有效时间。</p></li>
</ul>
<blockquote>
<p>验证码并不是由阿里云生成，而是由我们生成，传给阿里云短信服务。</p>
</blockquote>
<blockquote>
<p>使用工具类生成n位随机数</p>
</blockquote>
<h1 id="mq订单任务">MQ订单任务</h1>
<h2 id="消息的超时">消息的超时</h2>
<p>在电商业务里，有个需求：下单之后，如果用户在 15
分钟内未支付，则自动取消订单。</p>
<p>你可能奇怪，这种怎么也会用到消息队列的？</p>
<p>我来先简单解释一下，在单一服务的系统，可以起个定时任务就搞定了。</p>
<p>但是，在 SOA
或者微服务架构下，这样做就不行了。因为很多个服务都关心是否支付这件事，如果每种服务，都自己实现一套定时任务的逻辑，既重复，又难以维护。</p>
<p>在这种情况下，我们往往会做一层抽象：把要执行的任务封装成消息。当时间到了，直接扔到消息队列里，消息的订阅者们获取到消息后，直接执行即可。</p>
<p>希望把消息延迟一定时间再处理的，被称为延迟队列。</p>
<p>对于订单取消的这种业务，我们就会在创建订单的时候，同时扔一个包含了执行任务信息的消息到延迟队列，指定15分钟后，让订阅这个队列的各个消费者，可以收到这个消息。随后，各个消费者所在的系统就可以去执行相关的扫描订单的任务了。</p>
<p>RabbitMQ 和 Kafka 消息队列如何选？</p>
<p>先看下 RabbitMQ 的。</p>
<p>RabbitMQ 的消息自带手表，消息中有个 TTL 字段，可以设置消息在 RabbitMQ
中的存放的时间，超时了会被移送到一个叫死信队列的地方。</p>
<p>所以，延迟队列 RabbitMQ 最简单的实现方式就是设置
TTL，然后一个消费者去监听死信队列。当消息超时了，监听死信队列的消费者就收到消息了。</p>
<p>不过，这样做有个大问题：假设，我们先往队列放入一条过期时间是 10 秒的
A 消息，再放入一条过期时间是 5 秒的 B 消息。 那么问题来了，B 消息会先于
A 消息进入死信队列吗？</p>
<p>答案是否定的。B 消息会优先遵守队列的先进先出规则，在 A
消息过期后，和其一起进入死信队列被消费者消费。</p>
<p>在 RabbitMQ 的 3.5.8 版本以后，官方推荐的 rabbitmq delayed message
exchange 插件可以解决这个问题。</p>
<ul>
<li>用了这个插件，我们在发送消息的时候，把消息发往一个特殊的
Exchange。</li>
<li>同时，在消息头里指定要延迟的时间。</li>
<li>收到消息的 Exchange
并不会立即把消息放到队列里，而是在消息延迟时间到达后，才会把消息放入。</li>
</ul>
<p>Kafka 要实现延迟队列就很麻烦了。</p>
<ul>
<li>你先需要把消息先放入一个临时的 topic。</li>
<li>然后得自己开发一个做中转的消费者。让这个中间的消费者先去把消息从这个临时的
topic 取出来。</li>
<li>取出来，这消息还不能马上处理啊，因为没到时间呢。也没法保存在自己的内存里，怕崩溃了，消息没了。所以，就得把没有到时间的消息存入到数据库里。</li>
<li>存入数据库中的消息需要在时间到了之后再放入到 Kafka
里，以便真正的消费者去执行真正的业务逻辑。</li>
</ul>
<p>Kafka 是每秒几十万条消息吞吐，而 RabbitMQ
的吞吐量是每秒几万条消息。</p>
<p>其实，在一家公司内部，有必须用到 Kafka
那么大吞吐量的项目真的很少。大部分项目，像 RabbitMQ
那样每秒几万的消息吞吐，已经非常够了。</p>
<p>在一些没那么大吞吐量的项目中引入 Kafka，我觉得就不如引入
RabbitMQ。</p>
<p>为什么呢？</p>
<p>因为 Kafka
为了更好的吞吐量，很大程度上增加了自己的复杂度。而这些复杂度对项目来说，就是麻烦，主要体现在两个方面：</p>
<p>1、配置复杂、维护复杂</p>
<p>Kafka 的参数配置相对 RabbitMQ
是很复杂的。比如：磁盘管理相关参数，集群管理相关参数，ZooKeeper
交互相关参数，Topic 级别相关参数等，都需要一些思考和调优。</p>
<p>另外，Kafka 本身集群和参与管理集群的
ZooKeeper，这就带来了更多的维护成本。Kafka 要用好，你要考虑
JVM，消息持久化，集群本身交互，以及 ZooKeeper 本身和它与 Kafka
之间的可靠和效率。</p>
<p>2、用好，用对存在门槛</p>
<p>Kafka 的 Producer 和 Consumer 本身要用好用对也存在很高的门槛。</p>
<p>比如，Producer 消息可靠性保障、幂等性、事务消息等，都需要对
KafkaProducer 有深入的了解。</p>
<p>而 Consumer
更不用说了，光是一个日志偏移管理就让一大堆人掉了不少头发。</p>
<p>相对来说，RabbitMQ
就简单得多。你可能都不用配置什么，直接启动起来就能很稳定可靠地使用了。就算配置，也是寥寥几个参数设置即可。</p>
<p>所以，大家在项目中引入消息队列的时候，真的要好好考虑下，不要因为大家都鼓吹
Kafka 好，就无脑引入。</p>
<h2 id="总结">总结</h2>
<p>可以看到，如果我们要做消息队列选型，有两件事是必须要做好的：</p>
<ol type="1">
<li>列出业务最重要的几个特点</li>
<li>深入到消息队列的细节中去比较</li>
</ol>
<p>等我们对这些<a
target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=中间件&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A2298925188%7D">中间件</a>的特点非常熟悉之后，甚至可以把业务分解成不同的子业务，再根据不同的子业务的特征，引入不同的消息队列，即消息队列混用。这样，我们就可能会最大化我们的获益，最小化我们的成本。</p>
<p>说了这么多，其实还有很多 Kafka 和 RabbitMQ
的比较没有说，比如二者集群的区别，占用资源多少的比较等。以后有机会可以再提提。</p>
<h1
id="解决redismysql缓存双写不一致问题">解决Redis、MySQL缓存双写不一致问题</h1>
<p>但是在更新缓存方面，对于<code>更新完数据库，是更新缓存呢，还是删除缓存。</code>又或者是先<code>删除缓存，再更新数据库，其实大家存在很大的争议。</code>目前没有一篇全面的博客，对这几种方案进行解析。于是博主战战兢兢，顶着被大家喷的风险，写了这篇文章。</p>
<h3 id="正文">正文</h3>
<p><strong>给缓存数据设置过期时间</strong></p>
<p>先做一个说明，从理论上来说，给缓存设置过期时间，是保证最终一致性的解决方案。这种方案下，我们可以对存入缓存的数据设置过期时间，所有的写操作以数据库为准，对缓存操作只是尽最大努力即可。也就是说如果数据库写成功，缓存更新失败，那么只要到达过期时间，则后面的读请求自然会从数据库中读取新值然后回填缓存。因此，接下来讨论的思路不依赖于给缓存设置过期时间这个方案。</p>
<p>在这里，我们先讨论三种<strong>更新策略</strong>：</p>
<ol type="1">
<li>先更新数据库，再更新缓存</li>
<li>先删除缓存，再更新数据库</li>
<li>先更新数据库，再删除缓存</li>
</ol>
<blockquote>
<p>先更新数据库，再更新缓存</p>
</blockquote>
<p>这套方案，大家普遍反对。为什么呢？有如下两点：</p>
<ul>
<li>原因一（线程安全角度）</li>
</ul>
<p>（1）线程A更新了数据库 （2）线程B更新了数据库 （3）线程B更新了缓存
（4）线程A更新了缓存</p>
<p>这就出现请求A更新缓存应该比请求B更新缓存早才对，但是因为网络等原因，B却比A更早更新了缓存。这就导致了脏数据，因此不考虑。</p>
<ul>
<li>原因二（业务场景角度）</li>
</ul>
<p>（1）如果你是一个写数据库场景比较多，而读数据场景比较少的业务需求，采用这种方案就会导致，数据压根还没读到，缓存就被频繁的更新，浪费性能。</p>
<p>（2）如果你写入数据库的值，并不是直接写入缓存的，而是要经过一系列复杂的计算再写入缓存。那么，每次写入数据库后，都再次计算写入缓存的值，无疑是浪费性能的。显然，删除缓存更为适合。</p>
<blockquote>
<p>先删除缓存，再更新数据库</p>
</blockquote>
<p>该方案会导致不一致原因是。同时一个请求A进行更新操作，另一个请求B进行查询操作。那么会出现如下情形：</p>
<p>（1）请求A进行写操作，删除缓存 （2）请求B查询发现缓存不存在
（3）请求B去数据库查询得到旧值 （4）请求B将旧值写入缓存
（5）请求A将新值写入数据库</p>
<p>上述情况就会导致不一致的情形出现。而且，如果不采用给缓存设置过期时间策略，该数据永远都是脏数据。</p>
<p><strong>那么，如何解决呢？采用延时双删策略</strong></p>
<h3 id="缓存延时双删">缓存延时双删</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ICacheService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisOperator redisOperator;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IShopService shopService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 采用延时双删，解决数据库和缓存的一致性</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateHotCount</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//删除缓存</span></span><br><span class="line">            redisOperator.del(<span class="string">&quot;redis_key_&quot;</span> + id);</span><br><span class="line">            <span class="comment">//更新数据库</span></span><br><span class="line">            shopService.updataHotShop();</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);<span class="comment">//休眠1秒</span></span><br><span class="line">            <span class="comment">//延时删除</span></span><br><span class="line">            redisOperator.del(<span class="string">&quot;redis_key_&quot;</span> + id);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getHotCount</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>解释：</p>
<ol type="1">
<li>先淘汰缓存</li>
<li>再写数据库</li>
<li>休眠1秒，再淘汰缓存（<strong>这么做，可以将1秒内所造成的缓存脏数据，再次删除。</strong>）</li>
</ol>
<p><strong>针对上面的情形，读者应该自行评估自己的项目的读数据业务逻辑的耗时。然后写数据的休眠时间则在读数据业务逻辑的耗时基础上，加几百ms即可。这么做的目的，就是确保读请求结束，写请求可以删除读请求造成的缓存脏数据。</strong></p>
<p><strong>如果数据库采用了读写分离架构，这么办？</strong>（<strong>主库负责写操作，从库负责读操作</strong>）</p>
<p>ok，在这种情况下，造成数据不一致的原因如下，还是两个请求，一个请求A进行更新操作，另一个请求B进行查询操作。</p>
<p>（1）请求A进行写操作，删除缓存，请求A把数据写入主库，还没开始同步从库</p>
<p>（2）（1s内）请求B查询缓存，没有发现缓存，请求B去从库查询，这时还没有完成主从同步，查到是旧值，并且把旧值写入缓存。</p>
<p>（3）主库完成主从同步，从库变为新值</p>
<p>上述流程，就是数据不一致问题，还使用双删延时策略。只是，睡眠时间修改为在主从同步的延时时间基础之上，加几百ms</p>
<p><strong>采用这种同步淘汰策略，吞吐量降低怎么办？</strong></p>
<p>ok，那就将第二次删除作为异步的。自己起一个线程，异步删除。这样，写的请求就不用沉睡一段时间后了，再返回。这么做，加大吞吐量。</p>
<p>第二次删除,如果删除失败怎么办？</p>
<p>这是个非常好的问题，因为第二次删除失败，就会出现如下情形。还是有两个请求，一个请求A进行更新操作，另一个请求B进行查询操作，为了方便，假设是单库：</p>
<p>（1）请求A进行写操作，删除缓存 （2）请求B查询发现缓存不存在
（3）请求B去数据库查询得到旧值 （4）请求B将旧值写入缓存
（5）请求A将新值写入数据库
（6）请求A试图去删除请求B写入对缓存值，结果失败了。</p>
<p>ok,这也就是说。如果第二次删除缓存失败，会再次出现缓存和数据库不一致的问题。</p>
<p>如何解决呢？</p>
<p>具体解决方案，且看博主对第先更新数据库，再删缓存种更新策略的解析。</p>
<h3 id="删除缓存重试机制">删除缓存重试机制</h3>
<p>不管是<strong>延时双删</strong>还是<strong>Cache-Aside的先操作数据库再删除缓存</strong>，都可能会存在第二步的删除缓存失败，导致的数据不一致问题。可以使用这个方案优化：删除失败就多删除几次呀,保证删除缓存成功就可以了呀~
所以可以引入<strong>删除缓存重试机制</strong></p>
<figure>
<img
src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f5ef89955b4e489e831a14042073cb78~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<ol type="1">
<li>（1）更新数据库数据； （2）缓存因为种种问题删除失败
（3）将需要删除的key发送至消息队列 （4）自己消费消息，获得需要删除的key
（5）继续重试删除操作，直到成功</li>
</ol>
<p>然而，该方案有一个缺点，对业务线代码造成大量的侵入。于是有了方案二，在方案二中，启动一个订阅程序去订阅数据库的binlog，获得需要操作的数据。在应用程序中，另起一段程序，获得这个订阅程序传来的信息，进行删除缓存操作。</p>
<h3 id="读取biglog异步删除缓存">读取biglog异步删除缓存</h3>
<figure>
<img
src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96f8496ad8794b5599b15d125bab22b8~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>流程如下图所示：</p>
<p>（1）更新数据库数据 （2）数据库会将操作信息写入binlog日志当中
（3）订阅程序提取出所需要的数据以及key
（4）另起一段非业务代码，获得该信息 （5）尝试删除缓存操作，发现删除失败
（6）将这些信息发送至消息队列
（7）重新从消息队列中获得该数据，重试操作。</p>
<p>备注说明：上述的订阅binlog程序在mysql中有现成的中间件<strong>叫canal，</strong>可以完成订阅binlog日志的功能。至于oracle中，博主目前不知道有没有现成中间件可以使用。另外，重试机制，博主是采用的是消息队列的方式。如果对一致性要求不是很高，直接在程序中另起一个线程，每隔一段时间去重试即可，这些大家可以灵活自由发挥，只是提供一个思路。</p>
<p>本文其实是对目前互联网中已有的一致性方案，进行了一个总结。对于先删缓存，再更新数据库的更新策略，还有方案提出维护一个内存队列的方式，博主看了一下，觉得实现异常复杂，没有必要，因此没有必要在文中给出。最后，希望大家有所收获。</p>
<h1 id="排班管理">排班管理</h1>
<h2
id="根据医院编号查询医院所有科室列表">根据医院编号，查询医院所有科室列表</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据医院编号，查询医院所有科室列表</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;DepartmentVo&gt; <span class="title function_">findDeptTree</span><span class="params">(String hoscode)</span> &#123;</span><br><span class="line">    <span class="comment">//创建list集合，用于最终数据封装</span></span><br><span class="line">    List&lt;DepartmentVo&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据医院编号，查询医院所有科室信息</span></span><br><span class="line">    <span class="type">Department</span> <span class="variable">departmentQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Department</span>();</span><br><span class="line">    departmentQuery.setHoscode(hoscode);</span><br><span class="line">    <span class="type">Example</span> <span class="variable">example</span> <span class="operator">=</span> Example.of(departmentQuery);</span><br><span class="line">    <span class="comment">//所有科室列表 departmentList</span></span><br><span class="line">    List&lt;Department&gt; departmentList = departmentRepository.findAll(example);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据大科室编号  bigcode 分组，获取每个大科室里面下级子科室</span></span><br><span class="line">    Map&lt;String, List&lt;Department&gt;&gt; deparmentMap =</span><br><span class="line">            departmentList.stream().collect(Collectors.groupingBy(Department::getBigcode));</span><br><span class="line">    <span class="comment">//遍历map集合 deparmentMap</span></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String,List&lt;Department&gt;&gt; entry : deparmentMap.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//大科室编号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bigcode</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="comment">//大科室编号对应的全局数据</span></span><br><span class="line">        List&lt;Department&gt; deparment1List = entry.getValue();</span><br><span class="line">        <span class="comment">//封装大科室</span></span><br><span class="line">        <span class="type">DepartmentVo</span> <span class="variable">departmentVo1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DepartmentVo</span>();</span><br><span class="line">        departmentVo1.setDepcode(bigcode);</span><br><span class="line">        departmentVo1.setDepname(deparment1List.get(<span class="number">0</span>).getBigname());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装小科室</span></span><br><span class="line">        List&lt;DepartmentVo&gt; children = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(Department department: deparment1List) &#123;</span><br><span class="line">            <span class="type">DepartmentVo</span> <span class="variable">departmentVo2</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">DepartmentVo</span>();</span><br><span class="line">            departmentVo2.setDepcode(department.getDepcode());</span><br><span class="line">            departmentVo2.setDepname(department.getDepname());</span><br><span class="line">            <span class="comment">//封装到list集合</span></span><br><span class="line">            children.add(departmentVo2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//把小科室list集合放到大科室children里面</span></span><br><span class="line">        departmentVo1.setChildren(children);</span><br><span class="line">        <span class="comment">//放到最终result里面</span></span><br><span class="line">        result.add(departmentVo1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="根据医院编号和科室编号-查询排班规则数据">根据医院编号和科室编号
，查询排班规则数据</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ScheduleRepository scheduleRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HospitalService hospitalService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据医院编号 和 科室编号 ，查询排班规则数据</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getRuleSchedule</span><span class="params">(<span class="type">long</span> page, <span class="type">long</span> limit, String hoscode, String depcode)</span> &#123;</span><br><span class="line">    <span class="comment">//1 根据医院编号 和 科室编号 查询</span></span><br><span class="line">    <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;hoscode&quot;</span>).is(hoscode).and(<span class="string">&quot;depcode&quot;</span>).is(depcode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 根据工作日workDate期进行分组</span></span><br><span class="line">    <span class="type">Aggregation</span> <span class="variable">agg</span> <span class="operator">=</span> Aggregation.newAggregation(</span><br><span class="line">            Aggregation.match(criteria),<span class="comment">//匹配条件</span></span><br><span class="line">            Aggregation.group(<span class="string">&quot;workDate&quot;</span>)<span class="comment">//分组字段</span></span><br><span class="line">            .first(<span class="string">&quot;workDate&quot;</span>).as(<span class="string">&quot;workDate&quot;</span>)</span><br><span class="line">            <span class="comment">//3 统计号源数量</span></span><br><span class="line">            .count().as(<span class="string">&quot;docCount&quot;</span>)</span><br><span class="line">            .sum(<span class="string">&quot;reservedNumber&quot;</span>).as(<span class="string">&quot;reservedNumber&quot;</span>)</span><br><span class="line">            .sum(<span class="string">&quot;availableNumber&quot;</span>).as(<span class="string">&quot;availableNumber&quot;</span>),</span><br><span class="line">            <span class="comment">//排序</span></span><br><span class="line">            Aggregation.sort(Sort.Direction.DESC,<span class="string">&quot;workDate&quot;</span>),</span><br><span class="line">            <span class="comment">//4 实现分页</span></span><br><span class="line">            Aggregation.skip((page-<span class="number">1</span>)*limit),</span><br><span class="line">            Aggregation.limit(limit)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//调用方法，最终执行</span></span><br><span class="line">    AggregationResults&lt;BookingScheduleRuleVo&gt; aggResults =</span><br><span class="line">            mongoTemplate.aggregate(agg, Schedule.class, BookingScheduleRuleVo.class);</span><br><span class="line">    List&lt;BookingScheduleRuleVo&gt; bookingScheduleRuleVoList = aggResults.getMappedResults();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分组查询的总记录数</span></span><br><span class="line">    <span class="type">Aggregation</span> <span class="variable">totalAgg</span> <span class="operator">=</span> Aggregation.newAggregation(</span><br><span class="line">            Aggregation.match(criteria),</span><br><span class="line">            Aggregation.group(<span class="string">&quot;workDate&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    AggregationResults&lt;BookingScheduleRuleVo&gt; totalAggResults =</span><br><span class="line">            mongoTemplate.aggregate(totalAgg, </span><br><span class="line">Schedule.class, BookingScheduleRuleVo.class);</span><br><span class="line">    <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> totalAggResults.getMappedResults().size();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把日期对应星期获取</span></span><br><span class="line">    <span class="keyword">for</span>(BookingScheduleRuleVo bookingScheduleRuleVo:bookingScheduleRuleVoList) &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">workDate</span> <span class="operator">=</span> bookingScheduleRuleVo.getWorkDate();</span><br><span class="line">        <span class="type">String</span> <span class="variable">dayOfWeek</span> <span class="operator">=</span> <span class="built_in">this</span>.getDayOfWeek(<span class="keyword">new</span> <span class="title class_">DateTime</span>(workDate));</span><br><span class="line">        bookingScheduleRuleVo.setDayOfWeek(dayOfWeek);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置最终数据，进行返回</span></span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    result.put(<span class="string">&quot;bookingScheduleRuleList&quot;</span>,bookingScheduleRuleVoList);</span><br><span class="line">    result.put(<span class="string">&quot;total&quot;</span>,total);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取医院名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">hosName</span> <span class="operator">=</span> hospitalService.getHospName(hoscode);</span><br><span class="line">    <span class="comment">//其他基础数据</span></span><br><span class="line">    Map&lt;String, String&gt; baseMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    baseMap.put(<span class="string">&quot;hosname&quot;</span>,hosName);</span><br><span class="line">    result.put(<span class="string">&quot;baseMap&quot;</span>,baseMap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据日期获取周几数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dateTime</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getDayOfWeek</span><span class="params">(DateTime dateTime)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dayOfWeek</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">switch</span> (dateTime.getDayOfWeek()) &#123;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.SUNDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周日&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.MONDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周一&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.TUESDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周二&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.WEDNESDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周三&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.THURSDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周四&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.FRIDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周五&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DateTimeConstants.SATURDAY:</span><br><span class="line">            dayOfWeek = <span class="string">&quot;周六&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dayOfWeek;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="根据医院编号-科室编号和工作日期查询排班详细信息">根据医院编号
、科室编号和工作日期，查询排班详细信息</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据医院编号 、科室编号和工作日期，查询排班详细信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Schedule&gt; <span class="title function_">getDetailSchedule</span><span class="params">(String hoscode, String depcode, String workDate)</span> &#123;</span><br><span class="line">    <span class="comment">//根据参数查询mongodb</span></span><br><span class="line">    List&lt;Schedule&gt; scheduleList =</span><br><span class="line">            scheduleRepository.findScheduleByHoscodeAndDepcodeAndWorkDate(hoscode,depcode,<span class="keyword">new</span> <span class="title class_">DateTime</span>(workDate).toDate());</span><br><span class="line">    <span class="comment">//把得到list集合遍历，向设置其他值：医院名称、科室名称、日期对应星期</span></span><br><span class="line">    scheduleList.stream().forEach(item-&gt;&#123;</span><br><span class="line">        <span class="built_in">this</span>.packageSchedule(item);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> scheduleList;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//封装排班详情其他值 医院名称、科室名称、日期对应星期</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">packageSchedule</span><span class="params">(Schedule schedule)</span> &#123;</span><br><span class="line">    <span class="comment">//设置医院名称</span></span><br><span class="line">    schedule.getParam().put(<span class="string">&quot;hosname&quot;</span>,hospitalService.getHospName(schedule.getHoscode()));</span><br><span class="line">    <span class="comment">//设置科室名称</span></span><br><span class="line">    schedule.getParam().put(<span class="string">&quot;depname&quot;</span>,departmentService.getDepName(schedule.getHoscode(),schedule.getDepcode()));</span><br><span class="line">    <span class="comment">//设置日期对应星期</span></span><br><span class="line">    schedule.getParam().put(<span class="string">&quot;dayOfWeek&quot;</span>,<span class="built_in">this</span>.getDayOfWeek(<span class="keyword">new</span> <span class="title class_">DateTime</span>(schedule.getWorkDate())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="预约挂号">预约挂号</h1>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getBookingScheduleRule</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> limit, String hoscode, String depcode)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取预约规则</span></span><br><span class="line">        <span class="type">Hospital</span> <span class="variable">hospital</span> <span class="operator">=</span> hospitalService.getByHoscode(hoscode);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == hospital) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BookingRule</span> <span class="variable">bookingRule</span> <span class="operator">=</span> hospital.getBookingRule();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取可预约日期分页数据</span></span><br><span class="line">        <span class="type">IPage</span> <span class="variable">iPage</span> <span class="operator">=</span> <span class="built_in">this</span>.getListDate(page, limit, bookingRule);</span><br><span class="line">        <span class="comment">//当前页可预约日期</span></span><br><span class="line">        List&lt;Date&gt; dateList = iPage.getRecords();</span><br><span class="line">        <span class="comment">//获取可预约日期科室剩余预约数</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;hoscode&quot;</span>).is(hoscode).and(<span class="string">&quot;depcode&quot;</span>).is(depcode).and(<span class="string">&quot;workDate&quot;</span>).in(dateList);</span><br><span class="line">        <span class="type">Aggregation</span> <span class="variable">agg</span> <span class="operator">=</span> Aggregation.newAggregation(</span><br><span class="line">                Aggregation.match(criteria),</span><br><span class="line">                Aggregation.group(<span class="string">&quot;workDate&quot;</span>)<span class="comment">//分组字段</span></span><br><span class="line">                        .first(<span class="string">&quot;workDate&quot;</span>).as(<span class="string">&quot;workDate&quot;</span>)</span><br><span class="line">                        .count().as(<span class="string">&quot;docCount&quot;</span>)</span><br><span class="line">                        .sum(<span class="string">&quot;availableNumber&quot;</span>).as(<span class="string">&quot;availableNumber&quot;</span>)</span><br><span class="line">                        .sum(<span class="string">&quot;reservedNumber&quot;</span>).as(<span class="string">&quot;reservedNumber&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        AggregationResults&lt;BookingScheduleRuleVo&gt; aggregationResults = mongoTemplate.aggregate(agg, Schedule.class, BookingScheduleRuleVo.class);</span><br><span class="line">        List&lt;BookingScheduleRuleVo&gt; scheduleVoList = aggregationResults.getMappedResults();</span><br><span class="line">        <span class="comment">//获取科室剩余预约数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//合并数据 将统计数据ScheduleVo根据“安排日期”合并到BookingRuleVo</span></span><br><span class="line">        Map&lt;Date, BookingScheduleRuleVo&gt; scheduleVoMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(scheduleVoList)) &#123;</span><br><span class="line">            scheduleVoMap = scheduleVoList.stream().collect(Collectors.toMap(BookingScheduleRuleVo::getWorkDate, BookingScheduleRuleVo -&gt; BookingScheduleRuleVo));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取可预约排班规则</span></span><br><span class="line">        List&lt;BookingScheduleRuleVo&gt; bookingScheduleRuleVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>, len=dateList.size(); i&lt;len; i++) &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> dateList.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="type">BookingScheduleRuleVo</span> <span class="variable">bookingScheduleRuleVo</span> <span class="operator">=</span> scheduleVoMap.get(date);</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == bookingScheduleRuleVo) &#123; <span class="comment">// 说明当天没有排班医生</span></span><br><span class="line">                bookingScheduleRuleVo = <span class="keyword">new</span> <span class="title class_">BookingScheduleRuleVo</span>();</span><br><span class="line">                <span class="comment">//就诊医生人数</span></span><br><span class="line">                bookingScheduleRuleVo.setDocCount(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//科室剩余预约数  -1表示无号</span></span><br><span class="line">                bookingScheduleRuleVo.setAvailableNumber(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            bookingScheduleRuleVo.setWorkDate(date);</span><br><span class="line">            bookingScheduleRuleVo.setWorkDateMd(date);</span><br><span class="line">            <span class="comment">//计算当前预约日期为周几</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">dayOfWeek</span> <span class="operator">=</span> <span class="built_in">this</span>.getDayOfWeek(<span class="keyword">new</span> <span class="title class_">DateTime</span>(date));</span><br><span class="line">            bookingScheduleRuleVo.setDayOfWeek(dayOfWeek);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//最后一页最后一条记录为即将预约   状态 0：正常 1：即将放号 -1：当天已停止挂号</span></span><br><span class="line">            <span class="keyword">if</span>(i == len-<span class="number">1</span> &amp;&amp; page == iPage.getPages()) &#123;</span><br><span class="line">                bookingScheduleRuleVo.setStatus(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bookingScheduleRuleVo.setStatus(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当天预约如果过了停号时间， 不能预约</span></span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span> &amp;&amp; page == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">DateTime</span> <span class="variable">stopTime</span> <span class="operator">=</span> <span class="built_in">this</span>.getDateTime(<span class="keyword">new</span> <span class="title class_">Date</span>(), bookingRule.getStopTime());</span><br><span class="line">                <span class="keyword">if</span>(stopTime.isBeforeNow()) &#123;</span><br><span class="line">                    <span class="comment">//停止预约</span></span><br><span class="line">                    bookingScheduleRuleVo.setStatus(-<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            bookingScheduleRuleVoList.add(bookingScheduleRuleVo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//可预约日期规则数据</span></span><br><span class="line">        result.put(<span class="string">&quot;bookingScheduleList&quot;</span>, bookingScheduleRuleVoList);</span><br><span class="line">        result.put(<span class="string">&quot;total&quot;</span>, iPage.getTotal());</span><br><span class="line">        <span class="comment">//其他基础数据</span></span><br><span class="line">        Map&lt;String, String&gt; baseMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//医院名称</span></span><br><span class="line">        baseMap.put(<span class="string">&quot;hosname&quot;</span>, hospitalService.getHospName(hoscode));</span><br><span class="line">        <span class="comment">//科室</span></span><br><span class="line">        <span class="type">Department</span> <span class="variable">department</span> <span class="operator">=</span>departmentService.getDepartment(hoscode, depcode);</span><br><span class="line">        <span class="comment">//大科室名称</span></span><br><span class="line">        baseMap.put(<span class="string">&quot;bigname&quot;</span>, department.getBigname());</span><br><span class="line">        <span class="comment">//科室名称</span></span><br><span class="line">        baseMap.put(<span class="string">&quot;depname&quot;</span>, department.getDepname());</span><br><span class="line"><span class="comment">//月</span></span><br><span class="line">        baseMap.put(<span class="string">&quot;workDateString&quot;</span>, <span class="keyword">new</span> <span class="title class_">DateTime</span>().toString(<span class="string">&quot;yyyy年MM月&quot;</span>));</span><br><span class="line"><span class="comment">//放号时间</span></span><br><span class="line">        baseMap.put(<span class="string">&quot;releaseTime&quot;</span>, bookingRule.getReleaseTime());</span><br><span class="line"><span class="comment">//停号时间</span></span><br><span class="line">        baseMap.put(<span class="string">&quot;stopTime&quot;</span>, bookingRule.getStopTime());</span><br><span class="line">        result.put(<span class="string">&quot;baseMap&quot;</span>, baseMap);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可预约日期分页数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> IPage&lt;Date&gt; <span class="title function_">getListDate</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> limit, BookingRule bookingRule)</span> &#123;</span><br><span class="line"><span class="comment">//当天放号时间</span></span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">releaseTime</span> <span class="operator">=</span> <span class="built_in">this</span>.getDateTime(<span class="keyword">new</span> <span class="title class_">Date</span>(), bookingRule.getReleaseTime());</span><br><span class="line"><span class="comment">//预约周期</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">cycle</span> <span class="operator">=</span> bookingRule.getCycle();</span><br><span class="line"><span class="comment">//如果当天放号时间已过，则预约周期后一天为即将放号时间，周期加1</span></span><br><span class="line">        <span class="keyword">if</span>(releaseTime.isBeforeNow()) cycle += <span class="number">1</span>;</span><br><span class="line"><span class="comment">//可预约所有日期，最后一天显示即将放号倒计时</span></span><br><span class="line">        List&lt;Date&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; cycle; i++) &#123;</span><br><span class="line"><span class="comment">//计算当前预约日期</span></span><br><span class="line">            <span class="type">DateTime</span> <span class="variable">curDateTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>().plusDays(i);</span><br><span class="line">            <span class="type">String</span> <span class="variable">dateString</span> <span class="operator">=</span> curDateTime.toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">            dateList.add(<span class="keyword">new</span> <span class="title class_">DateTime</span>(dateString).toDate());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//日期分页，由于预约周期不一样，页面一排最多显示7天数据，多了就要分页显示</span></span><br><span class="line">        List&lt;Date&gt; pageDateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (page-<span class="number">1</span>)*limit;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> (page-<span class="number">1</span>)*limit+limit;</span><br><span class="line">        <span class="keyword">if</span>(end &gt;dateList.size()) end = dateList.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) &#123;</span><br><span class="line">            pageDateList.add(dateList.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        IPage&lt;Date&gt; iPage = <span class="keyword">new</span> <span class="title class_">com</span>.baomidou.mybatisplus.extension.plugins.pagination.Page(page, <span class="number">7</span>, dateList.size());</span><br><span class="line">        iPage.setRecords(pageDateList);</span><br><span class="line">        <span class="keyword">return</span> iPage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将Date日期（yyyy-MM-dd HH:mm）转换为DateTime</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> DateTime <span class="title function_">getDateTime</span><span class="params">(Date date, String timeString)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dateTimeString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(date).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; &quot;</span>+ timeString;</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> DateTimeFormat.forPattern(<span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>).parseDateTime(dateTimeString);</span><br><span class="line">        <span class="keyword">return</span> dateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="预约下单">预约下单</h1>
<p>下单参数：就诊人id与排班id</p>
<p>1、下单我们要获取就诊人信息</p>
<p>2、获取排班下单信息与规则信息</p>
<p>3、获取医院签名信息，然后通过接口去医院预约下单</p>
<p>4、下单成功更新排班信息与发送短信</p>
<h2 id="根据排班id获取预约下单数据">根据排班id获取预约下单数据</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据排班id获取预约下单数据</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ScheduleOrderVo <span class="title function_">getScheduleOrderVo</span><span class="params">(String scheduleId)</span> &#123;</span><br><span class="line">    <span class="type">ScheduleOrderVo</span> <span class="variable">scheduleOrderVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduleOrderVo</span>();</span><br><span class="line">    <span class="comment">//排班信息</span></span><br><span class="line">    <span class="type">Schedule</span> <span class="variable">schedule</span> <span class="operator">=</span> baseMapper.selectById(scheduleId);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == schedule) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取预约规则信息</span></span><br><span class="line">    <span class="type">Hospital</span> <span class="variable">hospital</span> <span class="operator">=</span> hospitalService.getByHoscode(schedule.getHoscode());</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == hospital) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">BookingRule</span> <span class="variable">bookingRule</span> <span class="operator">=</span> hospital.getBookingRule();</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == bookingRule) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    scheduleOrderVo.setHoscode(schedule.getHoscode());</span><br><span class="line">    scheduleOrderVo.setHosname(hospitalService.getHospName(schedule.getHoscode()));</span><br><span class="line">    scheduleOrderVo.setDepcode(schedule.getDepcode());</span><br><span class="line">    scheduleOrderVo.setDepname(departmentService.getDepName(schedule.getHoscode(), schedule.getDepcode()));</span><br><span class="line">    scheduleOrderVo.setHosScheduleId(schedule.getHosScheduleId());</span><br><span class="line">    scheduleOrderVo.setAvailableNumber(schedule.getAvailableNumber());</span><br><span class="line">    scheduleOrderVo.setTitle(schedule.getTitle());</span><br><span class="line">    scheduleOrderVo.setReserveDate(schedule.getWorkDate());</span><br><span class="line">    scheduleOrderVo.setReserveTime(schedule.getWorkTime());</span><br><span class="line">    scheduleOrderVo.setAmount(schedule.getAmount());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//退号截止天数（如：就诊前一天为-1，当天为0）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">quitDay</span> <span class="operator">=</span> bookingRule.getQuitDay();</span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">quitTime</span> <span class="operator">=</span> <span class="built_in">this</span>.getDateTime(<span class="keyword">new</span> <span class="title class_">DateTime</span>(schedule.getWorkDate()).plusDays(quitDay).toDate(), bookingRule.getQuitTime());</span><br><span class="line">    scheduleOrderVo.setQuitTime(quitTime.toDate());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//预约开始时间</span></span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="built_in">this</span>.getDateTime(<span class="keyword">new</span> <span class="title class_">Date</span>(), bookingRule.getReleaseTime());</span><br><span class="line">    scheduleOrderVo.setStartTime(startTime.toDate());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//预约截止时间</span></span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="built_in">this</span>.getDateTime(<span class="keyword">new</span> <span class="title class_">DateTime</span>().plusDays(bookingRule.getCycle()).toDate(), bookingRule.getStopTime());</span><br><span class="line">    scheduleOrderVo.setEndTime(endTime.toDate());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当天停止挂号时间</span></span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">stopTime</span> <span class="operator">=</span> <span class="built_in">this</span>.getDateTime(<span class="keyword">new</span> <span class="title class_">Date</span>(), bookingRule.getStopTime());</span><br><span class="line">    scheduleOrderVo.setStartTime(startTime.toDate());</span><br><span class="line">    <span class="keyword">return</span> scheduleOrderVo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="实现下单接口">实现下单接口</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">extends</span></span><br><span class="line">        <span class="title class_">ServiceImpl</span>&lt;OrderMapper, OrderInfo&gt; <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PatientFeignClient patientFeignClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HospitalFeignClient hospitalFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存订单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">saveOrder</span><span class="params">(String scheduleId, Long patientId)</span> &#123;</span><br><span class="line">        <span class="type">Patient</span> <span class="variable">patient</span> <span class="operator">=</span> patientFeignClient.getPatient(patientId);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == patient) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ScheduleOrderVo</span> <span class="variable">scheduleOrderVo</span> <span class="operator">=</span> hospitalFeignClient.getScheduleOrderVo(scheduleId);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == scheduleOrderVo) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//当前时间不可以预约</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">new</span> <span class="title class_">DateTime</span>(scheduleOrderVo.getStartTime()).isAfterNow()</span><br><span class="line">                || <span class="keyword">new</span> <span class="title class_">DateTime</span>(scheduleOrderVo.getEndTime()).isBeforeNow()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.TIME_NO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SignInfoVo</span> <span class="variable">signInfoVo</span> <span class="operator">=</span> hospitalFeignClient.getSignInfoVo(scheduleOrderVo.getHoscode());</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == scheduleOrderVo) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(scheduleOrderVo.getAvailableNumber() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.NUMBER_NO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">        BeanUtils.copyProperties(scheduleOrderVo, orderInfo);</span><br><span class="line">        <span class="type">String</span> <span class="variable">outTradeNo</span> <span class="operator">=</span> System.currentTimeMillis() + <span class="string">&quot;&quot;</span>+ <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">100</span>);</span><br><span class="line">        orderInfo.setOutTradeNo(outTradeNo);</span><br><span class="line">        orderInfo.setScheduleId(scheduleId);</span><br><span class="line">        orderInfo.setUserId(patient.getUserId());</span><br><span class="line">        orderInfo.setPatientId(patientId);</span><br><span class="line">        orderInfo.setPatientName(patient.getName());</span><br><span class="line">        orderInfo.setPatientPhone(patient.getPhone());</span><br><span class="line">        orderInfo.setOrderStatus(OrderStatusEnum.UNPAID.getStatus());</span><br><span class="line">        <span class="built_in">this</span>.save(orderInfo);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">&quot;hoscode&quot;</span>,orderInfo.getHoscode());</span><br><span class="line">        paramMap.put(<span class="string">&quot;depcode&quot;</span>,orderInfo.getDepcode());</span><br><span class="line">        paramMap.put(<span class="string">&quot;hosScheduleId&quot;</span>,orderInfo.getScheduleId());</span><br><span class="line">        paramMap.put(<span class="string">&quot;reserveDate&quot;</span>,<span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getReserveDate()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>));</span><br><span class="line">        paramMap.put(<span class="string">&quot;reserveTime&quot;</span>, orderInfo.getReserveTime());</span><br><span class="line">        paramMap.put(<span class="string">&quot;amount&quot;</span>,orderInfo.getAmount());</span><br><span class="line">        paramMap.put(<span class="string">&quot;name&quot;</span>, patient.getName());</span><br><span class="line">        paramMap.put(<span class="string">&quot;certificatesType&quot;</span>,patient.getCertificatesType());</span><br><span class="line">        paramMap.put(<span class="string">&quot;certificatesNo&quot;</span>, patient.getCertificatesNo());</span><br><span class="line">        paramMap.put(<span class="string">&quot;sex&quot;</span>,patient.getSex());</span><br><span class="line">        paramMap.put(<span class="string">&quot;birthdate&quot;</span>, patient.getBirthdate());</span><br><span class="line">        paramMap.put(<span class="string">&quot;phone&quot;</span>,patient.getPhone());</span><br><span class="line">        paramMap.put(<span class="string">&quot;isMarry&quot;</span>, patient.getIsMarry());</span><br><span class="line">        paramMap.put(<span class="string">&quot;provinceCode&quot;</span>,patient.getProvinceCode());</span><br><span class="line">        paramMap.put(<span class="string">&quot;cityCode&quot;</span>, patient.getCityCode());</span><br><span class="line">        paramMap.put(<span class="string">&quot;districtCode&quot;</span>,patient.getDistrictCode());</span><br><span class="line">        paramMap.put(<span class="string">&quot;address&quot;</span>,patient.getAddress());</span><br><span class="line">        <span class="comment">//联系人</span></span><br><span class="line">        paramMap.put(<span class="string">&quot;contactsName&quot;</span>,patient.getContactsName());</span><br><span class="line">        paramMap.put(<span class="string">&quot;contactsCertificatesType&quot;</span>, patient.getContactsCertificatesType());</span><br><span class="line">        paramMap.put(<span class="string">&quot;contactsCertificatesNo&quot;</span>,patient.getContactsCertificatesNo());</span><br><span class="line">        paramMap.put(<span class="string">&quot;contactsPhone&quot;</span>,patient.getContactsPhone());</span><br><span class="line">        paramMap.put(<span class="string">&quot;timestamp&quot;</span>, HttpRequestHelper.getTimestamp());</span><br><span class="line">        <span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> HttpRequestHelper.getSign(paramMap, signInfoVo.getSignKey());</span><br><span class="line">        paramMap.put(<span class="string">&quot;sign&quot;</span>, sign);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> HttpRequestHelper.sendRequest(paramMap, signInfoVo.getApiUrl()+<span class="string">&quot;/order/submitOrder&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(result.getInteger(<span class="string">&quot;code&quot;</span>) == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> result.getJSONObject(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">            <span class="comment">//预约记录唯一标识（医院预约记录主键）</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">hosRecordId</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;hosRecordId&quot;</span>);</span><br><span class="line">            <span class="comment">//预约序号</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">number</span> <span class="operator">=</span> jsonObject.getInteger(<span class="string">&quot;number&quot;</span>);;</span><br><span class="line">            <span class="comment">//取号时间</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fetchTime</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;fetchTime&quot;</span>);;</span><br><span class="line">            <span class="comment">//取号地址</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fetchAddress</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;fetchAddress&quot;</span>);;</span><br><span class="line">            <span class="comment">//更新订单</span></span><br><span class="line">            orderInfo.setHosRecordId(hosRecordId);</span><br><span class="line">            orderInfo.setNumber(number);</span><br><span class="line">            orderInfo.setFetchTime(fetchTime);</span><br><span class="line">            orderInfo.setFetchAddress(fetchAddress);</span><br><span class="line">            baseMapper.updateById(orderInfo);</span><br><span class="line">            <span class="comment">//排班可预约数</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">reservedNumber</span> <span class="operator">=</span> jsonObject.getInteger(<span class="string">&quot;reservedNumber&quot;</span>);</span><br><span class="line">            <span class="comment">//排班剩余预约数</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">availableNumber</span> <span class="operator">=</span> jsonObject.getInteger(<span class="string">&quot;availableNumber&quot;</span>);</span><br><span class="line">            <span class="comment">//发送mq信息更新号源和短信通知</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(result.getString(<span class="string">&quot;message&quot;</span>), ResultCodeEnum.FAIL.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderInfo.getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="mq更新号源和订单">MQ更新号源和订单</h2>
<p>预约成功后我们要更新预约数和短信提醒预约成功，为了提高下单的并发性，这部分逻辑我们就交给mq为我们完成，预约成功发送消息即可。</p>
<p>如果商品服务和订单服务是两个不同的微服务，在下单的过程中订单服务需要调用商品服务进行扣库存操作。按照传统的方式，下单过程要等到调用完毕之后才能返回下单成功，如果网络产生波动等原因使得商品服务扣库存延迟或者失败，会带来较差的用户体验，如果在高并发的场景下，这样的处理显然是不合适的，那怎么进行优化呢？这就需要消息队列登场了。</p>
<p>消息队列提供一个异步通信机制，消息的发送者不必一直等待到消息被成功处理才返回，而是立即返回。消息中间件负责处理网络通信，如果网络连接不可用，消息被暂存于队列当中，当网络畅通的时候在将消息转发给相应的应用程序或者服务，当然前提是这些服务订阅了该队列。如果在商品服务和订单服务之间使用消息中间件，既可以提高并发量，又降低服务之间的耦合度。</p>
<p><strong>（2</strong>）典型应用场景：</p>
<p><strong>异步处理</strong>。把消息放入消息中间件中，等到需要的时候再去处理。</p>
<p><strong>流量削峰</strong>。例如秒杀活动，在短时间内访问量急剧增加，使用消息队列，当消息队列满了就拒绝响应，跳转到错误页面，这样就可以使得系统不会因为超负载而崩溃。</p>
<p><strong>日志处理</strong></p>
<p><strong>应用解耦</strong></p>
<h1 id="支付设置">支付设置</h1>
<ol type="1">
<li><p>appid：微信公众账号或开放平台APP的唯一标识</p></li>
<li><p>mch_id：商户号 (配置文件中的partner)</p></li>
<li><p>partnerkey：商户密钥</p></li>
<li><p>sign:数字签名,
根据微信官方提供的密钥和一套算法生成的一个加密信息,
就是为了保证交易的安全性</p></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeixinServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">WeixinService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据订单号下单，生成支付链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">createNative</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Map</span> <span class="variable">payMap</span> <span class="operator">=</span> (Map) redisTemplate.opsForValue().get(orderId.toString());</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> != payMap) <span class="keyword">return</span> payMap;</span><br><span class="line">            <span class="comment">//根据id获取订单信息</span></span><br><span class="line">            <span class="type">OrderInfo</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">            <span class="comment">// 保存交易记录</span></span><br><span class="line">            paymentService.savePaymentInfo(order, PaymentTypeEnum.WEIXIN.getStatus());</span><br><span class="line">            <span class="comment">//1、设置参数</span></span><br><span class="line">            <span class="type">Map</span> <span class="variable">paramMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            paramMap.put(<span class="string">&quot;appid&quot;</span>, ConstantPropertiesUtils.APPID);</span><br><span class="line">            paramMap.put(<span class="string">&quot;mch_id&quot;</span>, ConstantPropertiesUtils.PARTNER);</span><br><span class="line">            paramMap.put(<span class="string">&quot;nonce_str&quot;</span>, WXPayUtil.generateNonceStr());</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> order.getReserveDate() + <span class="string">&quot;就诊&quot;</span>+ order.getDepname();</span><br><span class="line">            paramMap.put(<span class="string">&quot;body&quot;</span>, body);</span><br><span class="line">            paramMap.put(<span class="string">&quot;out_trade_no&quot;</span>, order.getOutTradeNo());</span><br><span class="line">            <span class="comment">//paramMap.put(&quot;total_fee&quot;, order.getAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;total_fee&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;spbill_create_ip&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;notify_url&quot;</span>, <span class="string">&quot;http://guli.shop/api/order/weixinPay/weixinNotify&quot;</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;trade_type&quot;</span>, <span class="string">&quot;NATIVE&quot;</span>);</span><br><span class="line">            <span class="comment">//2、HTTPClient来根据URL访问第三方接口并且传递参数</span></span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>(<span class="string">&quot;https://api.mch.weixin.qq.com/pay/unifiedorder&quot;</span>);</span><br><span class="line">            <span class="comment">//client设置参数</span></span><br><span class="line">            client.setXmlParam(WXPayUtil.generateSignedXml(paramMap, ConstantPropertiesUtils.PARTNERKEY));</span><br><span class="line">            client.setHttps(<span class="literal">true</span>);</span><br><span class="line">            client.post();</span><br><span class="line">            <span class="comment">//3、返回第三方的数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> client.getContent();</span><br><span class="line">            Map&lt;String, String&gt; resultMap = WXPayUtil.xmlToMap(xml);</span><br><span class="line">            <span class="comment">//4、封装返回结果集</span></span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;orderId&quot;</span>, orderId);</span><br><span class="line">            map.put(<span class="string">&quot;totalFee&quot;</span>, order.getAmount());</span><br><span class="line">            map.put(<span class="string">&quot;resultCode&quot;</span>, resultMap.get(<span class="string">&quot;result_code&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;codeUrl&quot;</span>, resultMap.get(<span class="string">&quot;code_url&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> != resultMap.get(<span class="string">&quot;result_code&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//微信支付二维码2小时过期，可采取2小时未支付取消订单</span></span><br><span class="line">                redisTemplate.opsForValue().set(orderId.toString(), map, <span class="number">1000</span>, TimeUnit.MINUTES);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="支付查询">支付查询</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map <span class="title function_">queryPayStatus</span><span class="params">(Long orderId, String paymentType)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">        <span class="comment">//1、封装参数</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">paramMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">&quot;appid&quot;</span>, ConstantPropertiesUtils.APPID);</span><br><span class="line">        paramMap.put(<span class="string">&quot;mch_id&quot;</span>, ConstantPropertiesUtils.PARTNER);</span><br><span class="line">        paramMap.put(<span class="string">&quot;out_trade_no&quot;</span>, orderInfo.getOutTradeNo());</span><br><span class="line">        paramMap.put(<span class="string">&quot;nonce_str&quot;</span>, WXPayUtil.generateNonceStr());</span><br><span class="line">        <span class="comment">//2、设置请求</span></span><br><span class="line">        <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>(<span class="string">&quot;https://api.mch.weixin.qq.com/pay/orderquery&quot;</span>);</span><br><span class="line">        client.setXmlParam(WXPayUtil.generateSignedXml(paramMap, ConstantPropertiesUtils.PARTNERKEY));</span><br><span class="line">        client.setHttps(<span class="literal">true</span>);</span><br><span class="line">        client.post();</span><br><span class="line">        <span class="comment">//3、返回第三方的数据，转成Map</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> client.getContent();</span><br><span class="line">        Map&lt;String, String&gt; resultMap = WXPayUtil.xmlToMap(xml);</span><br><span class="line">        <span class="comment">//4、返回</span></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="取消预约">取消预约</h2>
<p>1、未支付取消订单，直接通知医院更新取消预约状态</p>
<p>2、已支付取消订单，先退款给用户，然后通知医院更新取消预约状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">refund</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PaymentInfo</span> <span class="variable">paymentInfoQuery</span> <span class="operator">=</span> paymentService.getPaymentInfo(orderId, PaymentTypeEnum.WEIXIN.getStatus());</span><br><span class="line"></span><br><span class="line">            <span class="type">RefundInfo</span> <span class="variable">refundInfo</span> <span class="operator">=</span> refundInfoService.saveRefundInfo(paymentInfoQuery);</span><br><span class="line">            <span class="keyword">if</span>(refundInfo.getRefundStatus().intValue() == RefundStatusEnum.REFUND.getStatus().intValue()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Map&lt;String,String&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;appid&quot;</span>,ConstantPropertiesUtils.APPID);       <span class="comment">//公众账号ID</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;mch_id&quot;</span>,ConstantPropertiesUtils.PARTNER);   <span class="comment">//商户编号</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;nonce_str&quot;</span>,WXPayUtil.generateNonceStr());</span><br><span class="line">            paramMap.put(<span class="string">&quot;transaction_id&quot;</span>,paymentInfoQuery.getTradeNo()); <span class="comment">//微信订单号</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;out_trade_no&quot;</span>,paymentInfoQuery.getOutTradeNo()); <span class="comment">//商户订单编号</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;out_refund_no&quot;</span>,<span class="string">&quot;tk&quot;</span>+paymentInfoQuery.getOutTradeNo()); <span class="comment">//商户退款单号</span></span><br><span class="line"><span class="comment">//       paramMap.put(&quot;total_fee&quot;,paymentInfoQuery.getTotalAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span></span><br><span class="line"><span class="comment">//       paramMap.put(&quot;refund_fee&quot;,paymentInfoQuery.getTotalAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;total_fee&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;refund_fee&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">paramXml</span> <span class="operator">=</span> WXPayUtil.generateSignedXml(paramMap,ConstantPropertiesUtils.PARTNERKEY);</span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>(<span class="string">&quot;https://api.mch.weixin.qq.com/secapi/pay/refund&quot;</span>);</span><br><span class="line">            client.setXmlParam(paramXml);</span><br><span class="line">            client.setHttps(<span class="literal">true</span>);</span><br><span class="line">            client.setCert(<span class="literal">true</span>);</span><br><span class="line">            client.setCertPassword(ConstantPropertiesUtils.PARTNER);</span><br><span class="line">            client.post();</span><br><span class="line"><span class="comment">//3、返回第三方的数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> client.getContent();</span><br><span class="line">            Map&lt;String, String&gt; resultMap = WXPayUtil.xmlToMap(xml);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != resultMap &amp;&amp; WXPayConstants.SUCCESS.equalsIgnoreCase(resultMap.get(<span class="string">&quot;result_code&quot;</span>))) &#123;</span><br><span class="line">                refundInfo.setCallbackTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                refundInfo.setTradeNo(resultMap.get(<span class="string">&quot;refund_id&quot;</span>));</span><br><span class="line">                refundInfo.setRefundStatus(RefundStatusEnum.REFUND.getStatus());</span><br><span class="line">                refundInfo.setCallbackContent(JSONObject.toJSONString(resultMap));</span><br><span class="line">                refundInfoService.updateById(refundInfo);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="取消预约-1">取消预约</h2>
<h3
id="未支付取消订单直接通知医院更新取消预约状态">未支付取消订单，直接通知医院更新取消预约状态</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">refund</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PaymentInfo</span> <span class="variable">paymentInfoQuery</span> <span class="operator">=</span> paymentService.getPaymentInfo(orderId, PaymentTypeEnum.WEIXIN.getStatus());</span><br><span class="line"></span><br><span class="line">            <span class="type">RefundInfo</span> <span class="variable">refundInfo</span> <span class="operator">=</span> refundInfoService.saveRefundInfo(paymentInfoQuery);</span><br><span class="line">            <span class="keyword">if</span>(refundInfo.getRefundStatus().intValue() == RefundStatusEnum.REFUND.getStatus().intValue()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Map&lt;String,String&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;appid&quot;</span>,ConstantPropertiesUtils.APPID);       <span class="comment">//公众账号ID</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;mch_id&quot;</span>,ConstantPropertiesUtils.PARTNER);   <span class="comment">//商户编号</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;nonce_str&quot;</span>,WXPayUtil.generateNonceStr());</span><br><span class="line">            paramMap.put(<span class="string">&quot;transaction_id&quot;</span>,paymentInfoQuery.getTradeNo()); <span class="comment">//微信订单号</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;out_trade_no&quot;</span>,paymentInfoQuery.getOutTradeNo()); <span class="comment">//商户订单编号</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;out_refund_no&quot;</span>,<span class="string">&quot;tk&quot;</span>+paymentInfoQuery.getOutTradeNo()); <span class="comment">//商户退款单号</span></span><br><span class="line"><span class="comment">//       paramMap.put(&quot;total_fee&quot;,paymentInfoQuery.getTotalAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span></span><br><span class="line"><span class="comment">//       paramMap.put(&quot;refund_fee&quot;,paymentInfoQuery.getTotalAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span></span><br><span class="line">            paramMap.put(<span class="string">&quot;total_fee&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            paramMap.put(<span class="string">&quot;refund_fee&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">paramXml</span> <span class="operator">=</span> WXPayUtil.generateSignedXml(paramMap,ConstantPropertiesUtils.PARTNERKEY);</span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>(<span class="string">&quot;https://api.mch.weixin.qq.com/secapi/pay/refund&quot;</span>);</span><br><span class="line">            client.setXmlParam(paramXml);</span><br><span class="line">            client.setHttps(<span class="literal">true</span>);</span><br><span class="line">            client.setCert(<span class="literal">true</span>);</span><br><span class="line">            client.setCertPassword(ConstantPropertiesUtils.PARTNER);</span><br><span class="line">            client.post();</span><br><span class="line"><span class="comment">//3、返回第三方的数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> client.getContent();</span><br><span class="line">            Map&lt;String, String&gt; resultMap = WXPayUtil.xmlToMap(xml);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != resultMap &amp;&amp; WXPayConstants.SUCCESS.equalsIgnoreCase(resultMap.get(<span class="string">&quot;result_code&quot;</span>))) &#123;</span><br><span class="line">                refundInfo.setCallbackTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                refundInfo.setTradeNo(resultMap.get(<span class="string">&quot;refund_id&quot;</span>));</span><br><span class="line">                refundInfo.setRefundStatus(RefundStatusEnum.REFUND.getStatus());</span><br><span class="line">                refundInfo.setCallbackContent(JSONObject.toJSONString(resultMap));</span><br><span class="line">                refundInfoService.updateById(refundInfo);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3
id="已支付取消订单先退款给用户然后通知医院更新取消预约状态">已支付取消订单，先退款给用户，然后通知医院更新取消预约状态</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">cancelOrder</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(orderId);</span><br><span class="line"><span class="comment">//当前时间大约退号时间，不能取消预约</span></span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">quitTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getQuitTime());</span><br><span class="line">        <span class="keyword">if</span>(quitTime.isBeforeNow()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.CANCEL_ORDER_NO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SignInfoVo</span> <span class="variable">signInfoVo</span> <span class="operator">=</span> hospitalFeignClient.getSignInfoVo(orderInfo.getHoscode());</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == signInfoVo) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; reqMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        reqMap.put(<span class="string">&quot;hoscode&quot;</span>,orderInfo.getHoscode());</span><br><span class="line">        reqMap.put(<span class="string">&quot;hosRecordId&quot;</span>,orderInfo.getHosRecordId());</span><br><span class="line">        reqMap.put(<span class="string">&quot;timestamp&quot;</span>, HttpRequestHelper.getTimestamp());</span><br><span class="line">        <span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> HttpRequestHelper.getSign(reqMap, signInfoVo.getSignKey());</span><br><span class="line">        reqMap.put(<span class="string">&quot;sign&quot;</span>, sign);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> HttpRequestHelper.sendRequest(reqMap, signInfoVo.getApiUrl()+<span class="string">&quot;/order/updateCancelStatus&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(result.getInteger(<span class="string">&quot;code&quot;</span>) != <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(result.getString(<span class="string">&quot;message&quot;</span>), ResultCodeEnum.FAIL.getCode());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//是否支付 退款</span></span><br><span class="line">            <span class="keyword">if</span>(orderInfo.getOrderStatus().intValue() == OrderStatusEnum.PAID.getStatus().intValue()) &#123;</span><br><span class="line"><span class="comment">//已支付 退款</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isRefund</span> <span class="operator">=</span> weixinService.refund(orderId);</span><br><span class="line">                <span class="keyword">if</span>(!isRefund) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YyghException</span>(ResultCodeEnum.CANCEL_ORDER_FAIL);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//更改订单状态</span></span><br><span class="line">            orderInfo.setOrderStatus(OrderStatusEnum.CANCLE.getStatus());</span><br><span class="line">            <span class="built_in">this</span>.updateById(orderInfo);</span><br><span class="line"><span class="comment">//发送mq信息更新预约数 我们与下单成功更新预约数使用相同的mq信息，不设置可预约数与剩余预约数，接收端可预约数减1即可</span></span><br><span class="line">            <span class="type">OrderMqVo</span> <span class="variable">orderMqVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMqVo</span>();</span><br><span class="line">            orderMqVo.setScheduleId(orderInfo.getScheduleId());</span><br><span class="line"><span class="comment">//短信提示</span></span><br><span class="line">            <span class="type">MsmVo</span> <span class="variable">msmVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MsmVo</span>();</span><br><span class="line">            msmVo.setPhone(orderInfo.getPatientPhone());</span><br><span class="line">            msmVo.setTemplateCode(<span class="string">&quot;SMS_194640722&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">reserveDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getReserveDate()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + (orderInfo.getReserveTime()==<span class="number">0</span> ? <span class="string">&quot;上午&quot;</span>: <span class="string">&quot;下午&quot;</span>);</span><br><span class="line">            Map&lt;String,Object&gt; param = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,Object&gt;()&#123;&#123;</span><br><span class="line">                put(<span class="string">&quot;title&quot;</span>, orderInfo.getHosname()+<span class="string">&quot;|&quot;</span>+orderInfo.getDepname()+<span class="string">&quot;|&quot;</span>+orderInfo.getTitle());</span><br><span class="line">                put(<span class="string">&quot;reserveDate&quot;</span>, reserveDate);</span><br><span class="line">                put(<span class="string">&quot;name&quot;</span>, orderInfo.getPatientName());</span><br><span class="line">            &#125;&#125;;</span><br><span class="line">            msmVo.setParam(param);</span><br><span class="line">            orderMqVo.setMsmVo(msmVo);</span><br><span class="line">            rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_ORDER, MqConst.ROUTING_ORDER, orderMqVo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="mybatis-plus">mybatis-plus</h1>
<p>MyBatis-Plus（简称 MP）是一个 MyBatis 的增强工具，在 MyBatis
的基础上只做增强不做改变，为简化开发、提高效率而生。</p>
<h2 id="主键策略">主键策略</h2>
<p>MyBatis-Plus默认的主键策略是：ASSIGN_ID （使用了雪花算法）</p>
<p>雪花算法：分布式ID生成器</p>
<p>雪花算法是由Twitter公布的分布式主键生成算法，它能够保证不同表的主键的不重复性，以及相同表的主键的有序性。</p>
<h1 id="百度地图选点">百度地图选点</h1>
<p>在网站的开发过程中,例如商家的注册等，需要商家设定自己的经纬度进行对商家的精确定位，同时也方便用户查找到附近距离范围内的商家。这样更利于网站的用户和商家互动。商家设定自己的经纬度就需要使用到百度地图2.0。此处为百度地图和Bootstrap模态框(Modal)的相关示例DEMO。直接上示例代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">   &lt;title&gt;百度地图选点--Bootstrap模态框(Modal)插件&lt;/title&gt;</span><br><span class="line">   &lt;link rel=&quot;stylesheet&quot; href=&quot;http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css&quot;&gt;</span><br><span class="line">   &lt;script src=&quot;http://libs.baidu.com/jquery/2.0.0/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=&quot;http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;http://api.map.baidu.com/api?v=2.0&amp;ak=2d12993ce41407db4050140fe342d9ba&quot;&gt;&lt;/script&gt;  </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"> </span><br><span class="line">&lt;h2&gt;百度地图选点--创建模态框(Modal)&lt;/h2&gt;</span><br><span class="line">&lt;!--按钮触发模态框 --&gt;</span><br><span class="line">&lt;button class=&quot;btn btn-primary btn-lg&quot; data-toggle=&quot;modal&quot; data-target=&quot;#myModal&quot; id=&quot;createMap&quot;&gt;点击选择设置百度地图&lt;/button&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; value=&quot;&quot; id=&quot;map&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line"> </span><br><span class="line">&lt;!--模态框（Modal） --&gt;</span><br><span class="line">&lt;div class=&quot;modal fade&quot; id=&quot;myModal&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot; aria-labelledby=&quot;myModalLabel&quot; aria-hidden=&quot;true&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal-dialog&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-hidden=&quot;true&quot;&gt; &amp;times;&lt;/button&gt;</span><br><span class="line">            &lt;h4 class=&quot;modal-title&quot; id=&quot;myModalLabel&quot;&gt;百度地图选点(鼠标滚动缩放地图,鼠标拖动移动地图)&lt;/h4&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-body&quot; id=&quot;map_main&quot; style=&quot;height:400px;&quot;&gt;在这里添加一些文本&lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">            &lt;input style=&quot;width:300px;float:left;&quot; type=&quot;text&quot; value=&quot;&quot; id=&quot;map_txt&quot; class=&quot;form-control&quot; readonly=&quot;&quot;/&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; onclick=&quot;setMapValue()&quot;&gt;设置为此地址&lt;/button&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;关闭&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"> </span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    $(function()&#123;</span><br><span class="line">        $(&quot;#createMap&quot;).click(function()&#123;</span><br><span class="line">            setTimeout(function() &#123;     //添加延时加载。解决问题</span><br><span class="line">                var map = new BMap.Map(&quot;map_main&quot;);</span><br><span class="line">                var myCity = new BMap.LocalCity();</span><br><span class="line">                myCity.get(function(res)&#123;</span><br><span class="line">                    map.centerAndZoom(res.center,res.level); </span><br><span class="line">                    var old_map = $(&#x27;#map&#x27;).val();      //如果已设置过</span><br><span class="line">                    if(old_map.length &gt; &#x27;5&#x27;)&#123;            //打开的时候显示已设置的</span><br><span class="line">                        $(&quot;#map_txt&quot;).val(old_map);     </span><br><span class="line">                        var oldMap = old_map.split(&quot;,&quot;);</span><br><span class="line">                        var point = new BMap.Point(oldMap[0],oldMap[1]);    </span><br><span class="line">                        var marker = new BMap.Marker(point);        // 创建标注    </span><br><span class="line">                        map.clearOverlays();</span><br><span class="line">                        map.addOverlay(marker);</span><br><span class="line">                    &#125;</span><br><span class="line">                    map.addEventListener(&quot;click&quot;, function(e)&#123;</span><br><span class="line">                        var lng_lat = e.point.lng+&#x27;,&#x27;+e.point.lat;</span><br><span class="line">                        $(&quot;#map_txt&quot;).val(lng_lat);                 //加入到设置框</span><br><span class="line">                        var point = new BMap.Point(e.point.lng,e.point.lat);    </span><br><span class="line">                        var marker = new BMap.Marker(point);        // 创建标注    </span><br><span class="line">                        map.clearOverlays();</span><br><span class="line">                        map.addOverlay(marker);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,300);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">    //设置经纬度</span><br><span class="line">    function setMapValue()&#123;</span><br><span class="line">        if($(&quot;#map_txt&quot;).val()==&quot;&quot;)&#123; alert(&#x27;你还没选择相应的坐标点^_^哦&#x27;); return false; &#125;</span><br><span class="line">        $(&quot;#map&quot;).val($(&quot;#map_txt&quot;).val());</span><br><span class="line">        $(&#x27;#myModal&#x27;).modal(&#x27;hide&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i> 学习</a>
              <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
              <a href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="fa fa-tag"></i> 项目</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/16/Convolutional%20Neural%20Network/" rel="prev" title="Convolutional Neural Network">
      <i class="fa fa-chevron-left"></i> Convolutional Neural Network
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/10/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E7%82%B9/" rel="next" title="操作系统知识点">
      操作系统知识点 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">项目介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BB%E9%99%A2%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.1.</span> <span class="nav-text">医院项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E8%B7%AF%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.2.</span> <span class="nav-text">快速路项目</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%A8%A1%E5%9D%97%E6%9E%84%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">项目模块构建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">表结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BB%E9%99%A2%E8%AE%BE%E7%BD%AE%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">医院设置表结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%97%E5%85%B8%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.</span> <span class="nav-text">数据字典表结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BB%E9%99%A2%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80%E7%BC%96%E5%8F%B7"><span class="nav-number">3.3.</span> <span class="nav-text">医院全局唯一编号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E7%89%87base64%E7%BC%96%E7%A0%81"><span class="nav-number">3.4.</span> <span class="nav-text">图片base64编码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%97%E5%85%B8%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA"><span class="nav-number">4.</span> <span class="nav-text">数据字典导入导出</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#easyexcel%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">4.1.</span> <span class="nav-text">easyexcel工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#listener"><span class="nav-number">4.2.</span> <span class="nav-text">Listener</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8-listener"><span class="nav-number">4.2.1.</span> <span class="nav-text">正确使用 Listener</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8-listener"><span class="nav-number">4.2.2.</span> <span class="nav-text">错误使用 Listener</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%97%E5%85%B8redis%E7%BC%93%E5%AD%98"><span class="nav-number">4.3.</span> <span class="nav-text">数据字典Redis缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98cacheable"><span class="nav-number">4.3.1.</span> <span class="nav-text">缓存@Cacheable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98cacheput"><span class="nav-number">4.3.2.</span> <span class="nav-text">缓存@CachePut</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E5%85%B3"><span class="nav-number">5.</span> <span class="nav-text">网关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx"><span class="nav-number">5.1.</span> <span class="nav-text">Nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="nav-number">5.2.</span> <span class="nav-text">跨域问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="nav-number">5.2.1.</span> <span class="nav-text">为什么有跨域问题？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nosql"><span class="nav-number">6.</span> <span class="nav-text">NoSQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">6.1.</span> <span class="nav-text">适用场景</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%8B%E6%9C%BA%E7%99%BB%E5%BD%95"><span class="nav-number">7.</span> <span class="nav-text">手机登录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#token%E7%94%9F%E6%88%90"><span class="nav-number">7.1.</span> <span class="nav-text">token生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E6%9C%BA%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9A%84%E5%8F%91%E9%80%81"><span class="nav-number">7.2.</span> <span class="nav-text">手机验证码的发送</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mq%E8%AE%A2%E5%8D%95%E4%BB%BB%E5%8A%A1"><span class="nav-number">8.</span> <span class="nav-text">MQ订单任务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E7%9A%84%E8%B6%85%E6%97%B6"><span class="nav-number">8.1.</span> <span class="nav-text">消息的超时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">8.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3redismysql%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98"><span class="nav-number">9.</span> <span class="nav-text">解决Redis、MySQL缓存双写不一致问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">9.0.1.</span> <span class="nav-text">正文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%BB%B6%E6%97%B6%E5%8F%8C%E5%88%A0"><span class="nav-number">9.0.2.</span> <span class="nav-text">缓存延时双删</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="nav-number">9.0.3.</span> <span class="nav-text">删除缓存重试机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96biglog%E5%BC%82%E6%AD%A5%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="nav-number">9.0.4.</span> <span class="nav-text">读取biglog异步删除缓存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%92%E7%8F%AD%E7%AE%A1%E7%90%86"><span class="nav-number">10.</span> <span class="nav-text">排班管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E5%8C%BB%E9%99%A2%E7%BC%96%E5%8F%B7%E6%9F%A5%E8%AF%A2%E5%8C%BB%E9%99%A2%E6%89%80%E6%9C%89%E7%A7%91%E5%AE%A4%E5%88%97%E8%A1%A8"><span class="nav-number">10.1.</span> <span class="nav-text">根据医院编号，查询医院所有科室列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E5%8C%BB%E9%99%A2%E7%BC%96%E5%8F%B7%E5%92%8C%E7%A7%91%E5%AE%A4%E7%BC%96%E5%8F%B7-%E6%9F%A5%E8%AF%A2%E6%8E%92%E7%8F%AD%E8%A7%84%E5%88%99%E6%95%B0%E6%8D%AE"><span class="nav-number">10.2.</span> <span class="nav-text">根据医院编号和科室编号
，查询排班规则数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E5%8C%BB%E9%99%A2%E7%BC%96%E5%8F%B7-%E7%A7%91%E5%AE%A4%E7%BC%96%E5%8F%B7%E5%92%8C%E5%B7%A5%E4%BD%9C%E6%97%A5%E6%9C%9F%E6%9F%A5%E8%AF%A2%E6%8E%92%E7%8F%AD%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="nav-number">10.3.</span> <span class="nav-text">根据医院编号
、科室编号和工作日期，查询排班详细信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A2%84%E7%BA%A6%E6%8C%82%E5%8F%B7"><span class="nav-number">11.</span> <span class="nav-text">预约挂号</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A2%84%E7%BA%A6%E4%B8%8B%E5%8D%95"><span class="nav-number">12.</span> <span class="nav-text">预约下单</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%8E%92%E7%8F%ADid%E8%8E%B7%E5%8F%96%E9%A2%84%E7%BA%A6%E4%B8%8B%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="nav-number">12.1.</span> <span class="nav-text">根据排班id获取预约下单数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3"><span class="nav-number">12.2.</span> <span class="nav-text">实现下单接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mq%E6%9B%B4%E6%96%B0%E5%8F%B7%E6%BA%90%E5%92%8C%E8%AE%A2%E5%8D%95"><span class="nav-number">12.3.</span> <span class="nav-text">MQ更新号源和订单</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E8%AE%BE%E7%BD%AE"><span class="nav-number">13.</span> <span class="nav-text">支付设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%9F%A5%E8%AF%A2"><span class="nav-number">13.1.</span> <span class="nav-text">支付查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E9%A2%84%E7%BA%A6"><span class="nav-number">13.2.</span> <span class="nav-text">取消预约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E9%A2%84%E7%BA%A6-1"><span class="nav-number">13.3.</span> <span class="nav-text">取消预约</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AA%E6%94%AF%E4%BB%98%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E7%9B%B4%E6%8E%A5%E9%80%9A%E7%9F%A5%E5%8C%BB%E9%99%A2%E6%9B%B4%E6%96%B0%E5%8F%96%E6%B6%88%E9%A2%84%E7%BA%A6%E7%8A%B6%E6%80%81"><span class="nav-number">13.3.1.</span> <span class="nav-text">未支付取消订单，直接通知医院更新取消预约状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%B2%E6%94%AF%E4%BB%98%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E5%85%88%E9%80%80%E6%AC%BE%E7%BB%99%E7%94%A8%E6%88%B7%E7%84%B6%E5%90%8E%E9%80%9A%E7%9F%A5%E5%8C%BB%E9%99%A2%E6%9B%B4%E6%96%B0%E5%8F%96%E6%B6%88%E9%A2%84%E7%BA%A6%E7%8A%B6%E6%80%81"><span class="nav-number">13.3.2.</span> <span class="nav-text">已支付取消订单，先退款给用户，然后通知医院更新取消预约状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mybatis-plus"><span class="nav-number">14.</span> <span class="nav-text">mybatis-plus</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E7%AD%96%E7%95%A5"><span class="nav-number">14.1.</span> <span class="nav-text">主键策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E9%80%89%E7%82%B9"><span class="nav-number">15.</span> <span class="nav-text">百度地图选点</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="aeowind"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">aeowind</p>
  <div class="site-description" itemprop="description">爱上一场认真的消遣</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/aeowind" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;aeowind" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.douban.com/people/129971630/" title="douban → https:&#x2F;&#x2F;www.douban.com&#x2F;people&#x2F;129971630&#x2F;" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>douban</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aeowind</span>
</div>



  <script>
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        document.title = '(*^▽^*)我藏好了哦~' + OriginTitle;
        clearTimeout(titleTime);
      } else {
        document.title = 'q(≧▽≦q)被你发现啦~' + OriginTitle;
        titleTime = setTimeout(function() {
          document.title = OriginTitle;
        }, 2000);
      }
    });
  </script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>

<!-- 页面点击小红心 -->

      <script type="text/javascript" src="/js/clicklove.js"></script>

